# 📝 更新日志 (Changelog) by:AI

本文档记录了插件的所有重要变更。

---

## [3.1.42] - 2025-11-19

### ✨ 新增功能

#### 组件系统完善
- 🎨 **Badge 组件**：新增徽章组件，用于显示标签、状态、数量等
  - 支持多种样式变体：`primary`, `secondary`, `success`, `warning`, `danger`, `info`, `gray`
  - 支持多种尺寸：`sm`, `md`, `lg`
  - 支持图标显示和自定义样式
  - 已应用于管理页面图表标题（"近7天"、"Top 10"、"折线图"等）
- 🎨 **Tabs 组件**：新增标签页组件，用于统一管理标签页导航
  - 支持三种样式变体：`underline`, `pills`, `default`
  - 支持图标和文字组合
  - 支持激活状态管理
  - 已应用于管理页面顶部导航栏

#### 僵尸群清理功能
- 🗑️ **僵尸群清理命令**：新增僵尸群清理功能
  - `#水群清理僵尸群`：列出所有僵尸群（数据库中存在但机器人已不在群中）
  - `#水群确认清理`：确认清理列出的僵尸群
  - 僵尸群判断标准：数据库中存在，但不在 `Bot.gl` 中（机器人已不在该群）
  - 显示群组信息：群名、群号（隐私化处理）、最后更新时间、天数
  - 分批显示：每批15个群组，避免消息过长
  - 二次确认机制：先查看列表，再确认清理，防止误操作
  - 5分钟有效期：确认有效期为5分钟，过期需重新查看
  - 合并转发消息：使用 `common.makeForwardMsg` 统一消息格式
  - 清理范围：删除群组的所有统计数据（用户统计、日统计、周统计、月统计、年统计、成就数据等）

### 🔧 技术优化

#### 组件系统优化
- ✅ **Input 组件扩展**：扩展 Input 组件功能
  - 新增 `maxlength` 参数支持（用于验证码输入框）
  - 新增 `accept` 参数支持（用于文件选择器）
  - 新增 `extraAttrs` 参数支持额外 HTML 属性
  - 更新 `renderInput()` 方法以支持新参数
- ✅ **组件统一使用**：将所有原生 HTML 元素替换为组件
  - 管理页面标签页导航使用 `Tabs` 组件
  - 图表标题中的徽章标签使用 `Badge` 组件
  - 所有原生 `<input>` 标签替换为 `Input` 组件
    - `Admin.js`：日期输入框、密码输入框
    - `Achievement.js`：密码输入框
    - `Settings.js`：文本输入框、验证码输入框、密码输入框
    - `Background.js`：文件输入框、密码输入框
  - 统一组件样式和行为，提升代码可维护性

#### 合并转发消息统一
- ✅ **统一消息格式**：所有合并转发消息统一使用 `common.makeForwardMsg`
  - 修改 `refreshSingleGroupAchievements` 方法
  - 修改 `refreshAllGroupsAchievements` 方法
  - 修改 `cleanZombieGroups` 方法
  - 修改 `confirmCleanZombieGroups` 方法
  - 代码更简洁，无需判断群聊/私聊场景
  - 与项目其他部分保持一致

#### 数据存储优化
- ✅ **静态变量存储**：修复 `pendingCleanGroups` 存储问题
  - 将 `pendingCleanGroups` 改为静态变量（`static pendingCleanGroups`）
  - 所有实例共享同一个 Map，数据持久保存
  - 即使插件重新加载或实例被重新创建，数据也不会丢失
  - 修复确认清理时找不到待清理列表的问题

### 🐛 问题修复

- ✅ 修复图表标题中 `Badge.render()` 无法正确解析的问题（模板字符串使用单引号导致）
  - 将所有包含 `Badge.render()` 的 `title` 从单引号改为反引号（模板字符串）
  - 修复消息趋势图、群组活跃度分布图、新增用户趋势图、消息密度分布图、数据统计页面图表标题
- ✅ 修复 `pendingCleanGroups` 数据丢失问题（改为静态变量）
- ✅ 修复确认清理时找不到待清理列表的问题
- ✅ 统一合并转发消息格式，提升代码一致性

### 📝 文档更新

- ✅ 更新 README.md，添加僵尸群清理功能说明，更新版本号为 3.1.42
- ✅ 更新 CHANGELOG.md，记录 3.1.42 版本的所有更新
- ✅ 更新 components/README.md，添加 Badge 和 Tabs 组件使用文档
- ✅ 更新 package.json 版本号为 3.1.42

---

## [3.1.41] - 2025-11-19

### 🎨 UI优化

#### 成就管理页面优化
- 🎯 **界面简化**：移除分类和排序筛选器，简化操作界面
  - 移除分类筛选下拉框（计数、字数、活跃、连续、自定义）
  - 移除排序选择下拉框（名称、分类、获得人数、稀有度）
  - 保留群组选择和搜索功能，界面更简洁
- 📊 **默认排序优化**：默认按获得人数降序排序
  - 自动按获得人数从高到低排序，无需手动选择
  - 搜索后仍保持人数排序，便于快速查看热门成就
- 🎨 **卡片样式优化**：采用简约设计风格
  - 移除复杂的装饰元素（稀有度标识条、图标等）
  - 简化布局：标题、描述、统计信息三层结构
  - 稀有度标签：右上角显示，不同稀有度使用不同颜色
  - 统计信息：底部显示获得人数和百分比，简洁明了
  - 响应式布局：移动端 1 列，小屏幕 2 列，大屏幕 3 列，超大屏幕 4 列

#### 群组选择优化
- 🔧 **移除"全部成就"选项**：简化群组选择逻辑
  - 移除"全部成就"选项，不再支持查看所有群组的汇总数据
  - 默认选择第一个群组，自动加载该群组的成就数据
  - 必须选择具体群组才能查看成就统计，数据更精确

### 🔧 技术优化

#### 成就管理功能优化
- ✅ **稀有度显示修复**：修复稀有度显示逻辑
  - 使用成就定义中的 `rarity` 属性，而非根据百分比计算
  - 添加稀有度标准化方法，支持大小写不匹配的情况（"Common" ↔ "common"）
  - 支持所有稀有度类型：common、uncommon、rare、epic、legendary、mythic、festival、special
  - 修复所有成就都显示为"传说"的问题
- ✅ **数据加载优化**：修复成就统计数据不显示的问题
  - 修复数据合并逻辑，确保统计数据正确匹配到成就
  - 统一 ID 格式（字符串）进行匹配，避免类型不匹配问题
  - 确保数字类型正确转换（parseInt 和 parseFloat）
  - 为稀有度设置默认值，避免显示错误
- ✅ **代码清理**：移除所有调试日志
  - 清理 `AdminAchievements.js` 中的所有 `console.log` 调试日志
  - 保留 `console.error` 和 `console.warn` 用于错误提示
  - 提升生产环境代码整洁度

#### 导出功能优化
- ✅ **资源清理优化**：修复导出功能的资源清理问题
  - 添加 `URL.revokeObjectURL()` 清理 blob URL，避免内存泄漏
  - 延迟清理资源，确保下载已开始
  - 改进链接创建方式，使用属性赋值替代 `setAttribute`

#### 滚动条美化
- 🎨 **全局滚动条美化**：统一美化所有页面的滚动条
  - 固定显示滚动条：所有滚动容器使用 `overflow-y-scroll`，确保滚动条始终显示
  - 美化样式：渐变背景、圆角设计、阴影效果
  - 交互效果：悬停时颜色加深并放大，激活时增强阴影
  - 主题适配：深色模式和浅色模式使用不同的颜色方案
  - 移动端优化：移动端滚动条宽度 8px（桌面端 10px）
  - 支持所有滚动容器：`.tab-content`、`.overflow-y-scroll`、`.overflow-x-scroll` 等

### 🐛 问题修复

- ✅ 修复成就管理页面所有成就都显示为"传说"的问题（使用成就定义中的 rarity 属性）
- ✅ 修复成就管理页面数据不显示的问题（统计数据匹配逻辑优化）
- ✅ 修复稀有度显示错误的问题（添加大小写规范化逻辑）
- ✅ 修复导出功能 blob URL 资源清理问题（添加 URL.revokeObjectURL）
- ✅ 修复滚动条在某些页面不显示的问题（统一使用 overflow-y-scroll）

### 📝 文档更新

- ✅ 更新 README.md，更新版本号为 3.1.41
- ✅ 更新 CHANGELOG.md，记录 3.1.41 版本的所有优化和修复
- ✅ 更新 package.json 版本号为 3.1.41

---

## [3.1.4] - 2025-11-17

### ✨ 新增功能

#### 管理页面功能扩展
- 📊 **数据统计页面**：新增数据统计管理页面
  - 支持日期范围筛选（开始日期和结束日期）
  - 消息趋势图：显示选定日期范围内的每日消息数趋势
  - 用户活跃度图：显示选定日期范围内的每日活跃用户数趋势
  - 详细数据表格：显示每日统计数据（日期、消息数、字数、活跃用户、活跃群组）
  - 数据导出功能：支持导出 CSV 格式的统计数据
  - 统计卡片：显示总消息数、总字数、活跃用户数、活跃群组数及变化百分比
  - 图表主题适配：支持深色/浅色模式切换，图表颜色自动适配
- 🏆 **成就管理页面**：新增成就管理功能
  - 成就列表展示：卡片式网格布局，显示所有成就信息
  - 群组筛选：支持选择不同群组查看该群组的成就统计
  - 搜索功能：支持按成就名称、描述、分类搜索
  - 默认排序：按获得人数降序排序
  - 稀有度显示：卡片右上角显示成就稀有度标签（普通、不常见、稀有、史诗、传说等）
  - 统计信息：显示获得人数和获得百分比
  - 数据导出：支持导出 CSV 格式的成就列表数据
  - 简约设计：卡片样式简洁清爽，信息层次清晰

#### 滚动条美化
- 🎨 **全局滚动条美化**：所有页面滚动条统一美化
  - 固定显示滚动条：所有滚动容器使用 `overflow-y-scroll`，确保滚动条始终显示
  - 美化样式：渐变背景、圆角设计、阴影效果
  - 交互效果：悬停时颜色加深并放大，激活时增强阴影
  - 主题适配：深色模式和浅色模式使用不同的颜色方案
  - 移动端优化：移动端滚动条宽度 8px（桌面端 10px）
  - 支持所有滚动容器：`.tab-content`、`.overflow-y-scroll`、`.overflow-x-scroll` 等

### 🚀 性能优化

#### 总统计查询性能优化
- ⚡ **批量查询优化**：优化 `#水群总统计` 命令的查询性能
  - 新增 `getAllGroupsInfoBatch()` 方法，批量获取所有群组信息
  - 消除 N+1 查询问题，从每个群单独查询改为一次性批量查询
  - 群名称查询从 N 次数据库查询优化为 1 次批量查询
  - 预期性能提升：50-90%（取决于群数量）

#### 总榜查询性能优化
- ⚡ **active_days 计算优化**：优化 `#水群总榜` 命令的活跃天数计算
  - 在 `active_days_stats` 子查询中添加过滤条件：`WHERE message_count > 0 OR word_count > 0`
  - 减少需要统计的数据量，只统计有实际消息或字数的记录
  - 预期性能提升：20-40%（取决于活跃用户比例）

#### 数据库索引优化
- 🗄️ **PostgreSQL 部分索引**：为总榜查询添加部分索引
  - 新增 `idx_daily_stats_user_date_count` 索引
  - 仅索引有消息或字数的记录（`WHERE message_count > 0 OR word_count > 0`）
  - 大幅减少索引大小，提升查询性能
  - SQLite 不支持部分索引，但会使用现有索引优化查询

#### 内存优化
- 💾 **群名称缓存优化**：优化总统计查询中的群名称获取
  - 从 Bot.gl 获取的群名称会更新到内存映射
  - 避免同一查询中重复查询相同群名称
  - 减少数据库查询和 Bot API 调用

### 🔧 技术优化

#### 批量查询方法扩展
- ✅ **DatabaseService 扩展**：
  - 新增 `getAllGroupsInfoBatch()` 方法，批量获取所有群组信息
  - 返回 `Map<groupId, groupName>` 映射，便于快速查找
  - 与现有的批量查询方法（`getAllGroupsUsersBatch`、`getAllGroupsDailyStatsBatch`、`getAllGroupsMonthlyStatsBatch`）配合使用

#### 查询优化
- ✅ **DataService 优化**：
  - `getGlobalStats()` 方法使用批量查询替代循环查询
  - 所有群组信息一次性获取，减少数据库往返次数
  - 优化内存使用，使用 Map 数据结构快速查找

### 📊 性能提升预期

对于 200 万消息的数据集：

1. **总统计查询（`#水群总统计`）**：
   - 之前：N+1 查询（每个群 1 次查询群信息）
   - 现在：1 次批量查询获取所有群信息
   - 预期提升：50-90%（取决于群数量）

2. **总榜查询（`#水群总榜`）**：
   - active_days 计算过滤了空记录
   - PostgreSQL 使用部分索引加速
   - 预期提升：20-40%（取决于活跃用户比例）

3. **缓存机制**：
   - 总榜和总统计结果缓存 5 分钟
   - 重复查询几乎瞬时返回

### 🎨 图表主题切换优化

#### 图表颜色适配优化
- 🎨 **主题切换时图表完全重新生成**：优化图表主题切换逻辑
  - 主题切换时，先销毁所有图表实例，然后重新创建
  - 确保新图表使用当前主题的正确颜色配置
  - 深色模式：所有文字使用纯白色 `#FFFFFF`
  - 浅色模式：所有文字使用纯黑色 `#000000`
  - 所有图表文字颜色（包括 tooltip、标签、坐标轴）都会正确更新

#### 主题监听器
- 👂 **MutationObserver 监听主题变化**：添加主题变化监听器
  - 使用 `MutationObserver` 监听 `document.documentElement` 的 `class` 属性变化
  - 主题切换时自动触发图表更新
  - 添加防抖处理，避免频繁触发
  - 只有在图表已初始化且数据已加载时才重新生成图表

#### 图表初始化优化
- 🔧 **修复刷新页面图表不显示问题**：
  - 修复 `initCharts` 方法，只在图表不存在时才创建
  - 避免刷新时重复销毁导致图表无法显示
  - 添加容器元素存在性检查，确保 DOM 准备好后再初始化
  - 添加 ECharts 加载检查，未加载时自动延迟重试
  - 确保所有图表都已初始化后再更新数据

#### 颜色配置统一
- 🎨 **统一主题颜色获取**：
  - 新增 `getThemeColors()` 方法，统一获取主题颜色配置
  - 返回 `textColor`、`gridColor`、`tooltipBg`、`borderColor` 等
  - 每次调用都重新读取当前主题状态，确保获取最新值
  - 所有图表的 `setOption` 都使用 `notMerge: true` 强制完全替换配置

#### 资源清理
- 🧹 **添加资源清理方法**：
  - 新增 `destroy()` 方法，用于清理所有资源
  - 包括停止主题监听、销毁图表、移除事件监听器等
  - 防止内存泄漏

### ✨ 新增功能

#### Umami 追踪脚本支持
- 📊 **Web 页面访问统计**：新增 Umami 追踪脚本配置支持
  - 在 `data/global.json` 中新增 `webServer.umami` 配置项
  - 支持配置 Umami 脚本 URL 和网站 ID
  - 脚本自动注入到所有 Web 页面的 `<head>` 标签中
  - 可通过配置开关启用/禁用追踪功能
  - 未启用或配置不完整时，不会注入任何脚本
  - 配置项：
    - `enabled`: 是否启用 Umami 追踪（默认：`false`）
    - `scriptUrl`: Umami 脚本 URL（例如：`https://your-umami-instance.com/script.js`）
    - `websiteId`: Umami 网站 ID

### 🎨 UI优化

#### 最近成就页面优化
- 🎯 **个人页面最近成就重写**：优化最近成就显示布局
  - 重写成就卡片组件结构，修复嵌套网格布局问题
  - 优化卡片布局：标题、描述、稀有度/日期、群组名称层次清晰
  - 稀有度和日期同一行显示，稀有度在左，日期在右
  - 日期格式统一为中文格式（`2025年11月17日`）
  - 响应式 3 列网格布局（移动端 1 列，平板 2 列，桌面 3 列）

#### 稀有度标签中文化
- 🏷️ **稀有度标签改为中文显示**：
  - 所有稀有度标签统一显示为中文
  - 映射关系：`Common` → `普通`、`Uncommon` → `不普通`、`Rare` → `稀有`、`Epic` → `史诗`、`Legendary` → `传说`、`Mythic` → `神话`、`Special` → `特殊`、`Festival` → `节日`
  - 影响页面：个人页面最近成就、成就页面
  - 添加稀有度值规范化逻辑，支持大小写不匹配的情况（配置文件使用小写，代码映射使用首字母大写）

#### 导航栏优化
- 🧭 **添加个人页面按钮**：在导航栏中添加个人页面入口
  - 顶部导航栏和左侧导航栏都新增"个人"按钮
  - 路由：`/profile`，图标：用户图标
  - 方便用户快速访问个人中心页面
- 🎨 **用户信息显示区域重写**：优化顶部导航栏用户信息显示
  - 将用户信息按钮改为 div 显示区域，样式与左侧导航栏保持一致
  - 使用统一的样式：`flex items-center gap-2 px-3 py-2 bg-gray-50 dark:bg-gray-800 rounded-lg`
  - 图标和文字颜色统一：图标 `text-gray-400 dark:text-gray-500`，文字 `text-gray-600 dark:text-gray-400`
  - 移除按钮的 hover 效果和边框，显示更简洁
- 🗑️ **移除左侧导航栏个人页面按钮**：简化左侧导航栏底部按钮布局
  - 移除左侧导航栏左下角的个人页面按钮（`userInfoBtn`）
  - 按钮组从 4 个按钮减少到 3 个（布局切换、主题切换、设置）
  - 用户可以通过导航栏中的"个人"按钮访问个人中心，无需重复按钮
  - 简化界面，减少冗余功能
- 🔧 **修复导航栏用户信息显示不一致问题**：
  - 修复顶部导航栏和页面内容中 `id="userId"` 冲突的问题
  - 顶部导航栏使用 `id="topNavUserId"`，避免与页面内容冲突
  - 统一顶部和左侧导航栏的显示逻辑，都优先显示用户名，没有用户名时才显示用户ID
  - 修复导航栏初始化时显示用户ID，异步更新后显示用户名的问题
  - 现在导航栏初始化时就会从 localStorage 读取用户名并显示，保持显示一致性

#### 排名徽章显示优化
- 🏷️ **排名徽章统一为数字显示**：优化排名徽章显示方式
  - 移除所有排名徽章的 SVG 图标（🥇🥈🥉）
  - 所有排名（包括前三名）统一显示为数字（1, 2, 3, 4, 5...）
  - 前三名仍保留特殊样式（金色/银色/铜色背景）
  - 其他排名使用默认样式
  - 影响页面：排行榜页面、群管理页面、用户管理页面
  - 代码更简洁，维护更方便，界面更统一

### 🎨 UI优化

#### 成就管理页面优化
- 🎨 **成就卡片简化**：优化成就卡片样式，采用简约设计
  - 移除复杂的装饰元素（稀有度标识条、图标等）
  - 简化布局：标题、描述、统计信息三层结构
  - 稀有度标签：右上角显示，不同稀有度使用不同颜色
  - 统计信息：底部显示获得人数和百分比，简洁明了
  - 响应式布局：移动端 1 列，小屏幕 2 列，大屏幕 3 列，超大屏幕 4 列

#### 数据统计页面优化
- 📊 **图表样式统一**：数据统计页面图表与概览页面保持一致
  - 图表配置完全对齐：grid、tooltip、axis 等配置统一
  - 动画效果一致：使用相同的动画配置
  - 主题切换一致：图表主题切换逻辑与概览页面相同
  - 颜色方案统一：使用相同的主题颜色配置

#### 滚动条美化
- 🎨 **全局滚动条样式**：统一美化所有页面的滚动条
  - 固定显示：使用 `overflow-y-scroll` 确保滚动条始终显示
  - 渐变设计：滚动条滑块使用蓝色渐变
  - 圆角样式：滚动条和滑块都使用圆角设计
  - 阴影效果：添加微妙的阴影效果，提升视觉层次
  - 交互反馈：悬停和激活状态有明确的视觉反馈
  - 主题适配：深色和浅色模式使用不同的颜色方案

### 🔧 技术优化

#### 成就管理功能优化
- ✅ **稀有度显示修复**：修复稀有度显示逻辑
  - 使用成就定义中的 `rarity` 属性，而非根据百分比计算
  - 添加稀有度标准化方法，支持大小写不匹配的情况
  - 支持所有稀有度类型：common、uncommon、rare、epic、legendary、mythic、festival、special
- ✅ **数据加载优化**：优化成就统计数据加载
  - 修复数据合并逻辑，确保统计数据正确匹配到成就
  - 统一 ID 格式（字符串）进行匹配，避免类型不匹配问题
  - 确保数字类型正确转换（parseInt 和 parseFloat）
- ✅ **代码清理**：移除所有调试日志
  - 清理 `AdminAchievements.js` 中的所有 `console.log` 调试日志
  - 保留 `console.error` 和 `console.warn` 用于错误提示
  - 提升生产环境代码整洁度

#### 滚动条样式优化
- ✅ **CSS 样式统一**：统一所有滚动条样式
  - 全局滚动条样式：为所有元素添加统一的滚动条样式
  - 特定元素样式：为 `.tab-content`、`.overflow-y-scroll` 等添加特定样式
  - Firefox 支持：使用 `scrollbar-width` 和 `scrollbar-color` 属性
  - 移动端优化：移动端使用更细的滚动条（8px）

### 🐛 问题修复

- ✅ 修复图表文字颜色不跟随主题切换的问题
- ✅ 修复刷新页面图表不显示的问题
- ✅ 修复主题切换时图表颜色更新不及时的问题
- ✅ 修复图表初始化时机问题（DOM 未准备好时初始化失败）
- ✅ 修复最近成就页面嵌套网格布局问题（移除重复的 grid 容器）
- ✅ 修复稀有度标签全部显示为"普通"的问题（添加大小写规范化逻辑）
- ✅ 修复导航栏用户ID显示不一致的问题（统一使用 displayName，优先显示用户名）
- ✅ 修复导航栏用户信息元素 ID 冲突问题（顶部导航栏使用 `topNavUserId`，避免与页面内容冲突）
- ✅ 修复成就管理页面数据不显示的问题（统计数据匹配逻辑优化）
- ✅ 修复成就管理页面稀有度显示错误的问题（使用成就定义中的 rarity 属性）
- ✅ 修复数据统计页面图表动画不一致的问题（统一图表配置）
- ✅ 修复导出功能 blob URL 资源清理问题（添加 URL.revokeObjectURL）

### 📝 文档更新

- ✅ 更新 README.md，添加数据统计和成就管理页面说明
- ✅ 更新 CHANGELOG.md，记录 3.1.4 版本的所有优化和修复

---

## [3.1.3] - 2025-11-16

### ✨ 新增功能

#### 成就系统扩展
- 🎯 **成就数量大幅增加**：系统默认成就从41个增加到60个（新增19个成就）
  - **计数类成就**：累计发言（7个等级）、单日发言（4个等级）
  - **字数类成就**：累计字数（4个等级）、单日字数（4个等级）
  - **活跃类成就**：活跃天数（4个等级）
  - **每日类成就**：新增3个成就（单日发言200条、单日字数1000/2000字）
  - **连续类成就**：新增2个高级成就（200天、365天）
  - **时段类成就**：新增3个时段成就（午间、下午、傍晚）
  - **社交类成就**：新增3个高级成就（周/月活跃、周/月字数、最长连续）
  - **竞赛类成就**：新增多个高级竞赛成就
- 🎉 **节日成就系统**：新增节日类成就，支持年度重复触发
  - **元旦成就**（1月1日）：新元启华章
  - **国际儿童节成就**（6月1日）：童心向未来
  - **国庆节成就**（10月1日）：盛世庆华诞
  - 节日成就在对应日期的发言时自动解锁
  - 节日成就使用 `festival` 稀有度，为全局成就
  - 获取后在任意群都显示为已获取，不重复获取

#### 时间窗口条件优化
- ⏰ **支持年度重复日期**：优化 `time_window` 条件判断逻辑
  - 支持 `MM-DDTHH:mm:ss` 格式，自动使用当前年份
  - 节日成就配置更简洁，无需每年更新日期
  - 每年自动匹配对应日期，实现真正的年度重复触发

### 🎨 成就名称优化

#### 名称全面优化
- 📝 **计数类成就**：
  - `初次登场` → `渐入佳境` → `百言成章` → `口若悬河` → `千言万语` → `滔滔不绝` → `万语千言`
  - 新增：`言无不尽`（20000条）、`口若悬河·极`（50000条）
- 📝 **字数类成就**：
  - `笔下生花` → `文思泉涌` → `文采飞扬` → `文坛巨匠`
  - 新增：`著作等身`（100000字）、`文坛泰斗`（500000字）
- 📝 **每日类成就**：
  - `每日初见` → `一日千里` → `舌战群雄` → `一日千言`
  - `落笔成章` → `妙笔生花` → `一日千字` → `笔下千言`
- 📝 **连续类成就**：
  - `三日连珠` → `七日不辍` → `月满勤勉` → `百日不怠` → `二百如一日` → `一年不辍`
- 📝 **时段类成就**：
  - 新增：`正午时分`（午间）、`午后时光`（下午）、`黄昏时分`（傍晚）
- 📝 **竞赛类成就**：
  - 新增多个高级竞赛成就，名称更具挑战性

### 🔧 技术优化

#### 路径系统统一
- 🔗 **URL路径统一**：统一所有链接使用 hash 路由格式
  - 移除后端路由 `/background/:token`、`/ranking/:token`、`/achievements/:token`
  - 所有链接统一为 `${baseUrl}/${token}#/route` 格式
  - 例如：`http://domain:port/token#/background`、`http://domain:port/token#/ranking`
  - 简化路由逻辑，提升一致性和可维护性

#### 命令触发优化
- ⌨️ **复制命令支持**：修复复制命令无法触发的问题
  - 在消息处理中自动清理零宽字符和不可见字符
  - 移除零宽字符（Zero-width characters）：`\u200B-\u200D\uFEFF\u00AD`
  - 规范化空白字符，将多个连续空白字符替换为单个空格
  - 移除首尾空白字符
  - 现在复制的命令（如 `#水群榜`）可以正常触发

#### 前端路由优化
- 🗺️ **路由日志清理**：移除前端路由系统的调试日志
  - 移除 `[Router] 处理初始路由` 日志输出
  - 移除路由未找到的警告日志
  - 减少控制台输出，提升生产环境整洁度

#### 成就列表样式简化
- 🎨 **成就列表UI简化**：优化成就列表显示样式，更简洁清爽
  - 减小字体大小：标题 64px → 48px，进度 44px → 32px
  - 简化卡片样式：移除渐变背景和复杂阴影效果
  - 简化分隔条：移除渐变，使用单色线条
  - 减小内边距和间距，提升信息密度
  - 移除 hover 动画效果，减少视觉干扰
  - 简化徽章样式：移除渐变和动画效果
  - 优化文字大小和字重，提升可读性

#### 代码优化
- ✅ **时间窗口解析优化**：支持 `MM-DDTHH:mm:ss` 格式，自动添加当前年份
- ✅ **成就文件结构**：新增 `festival.json` 文件，专门存放节日成就
- ✅ **代码清理**：优化成就名称，提升用户体验

### 🐛 问题修复

- ✅ 修复复制命令无法触发的问题（零宽字符和不可见字符导致正则匹配失败）
- ✅ 修复 URL 路径不统一的问题（统一使用 hash 路由）
- ✅ 修复前端路由日志过多的问题（移除调试日志）

### 📝 文档更新

- ✅ 更新 README.md，更新成就数量和分类说明
- ✅ 更新 CHANGELOG.md，记录 3.1.3 版本的所有更新
- ✅ 更新 package.json 版本号为 3.1.3

---

## [3.1.2] - 2025-11-15

### ✨ 新增功能

#### 管理页面图表优化
- 📊 **消息密度散点图**：
  - X轴：群组用户数
  - Y轴：消息数
  - 气泡大小：根据平均消息/用户计算（20-60px）
  - 气泡颜色：根据活跃度分级（红色=高活跃度，橙色=中等活跃度，绿色=正常活跃度，蓝色=低活跃度）
  - 支持查看所有群组的消息密度分布，便于识别高活跃群组和异常群组
- 📈 **群组增长趋势图**：
  - 显示近7天每日新增群组数
  - 使用折线图 + 面积图展示趋势
  - 橙色主题，平滑曲线，渐变填充
  - 支持悬停查看详细数据

#### 管理页面移动端优化
- 📱 **用户管理页面移动端适配**：
  - 优化搜索框样式，与群管理页面保持一致
  - 添加搜索框清除按钮，支持一键清空搜索
  - 优化统计卡片布局，移动端2列显示，PC端4列显示
  - 优化详情面板布局，移动端全屏显示，PC端侧边栏显示
  - 优化按钮布局，移动端自适应宽度，PC端固定宽度
  - 优化时间信息卡片，移动端单列显示，PC端双列显示
  - 移除筛选下拉框，简化搜索栏界面
  - 统一统计信息显示格式（"共 X 个用户"）
- 📱 **系统设置页面移动端适配**：
  - 优化页面间距和布局，移动端更紧凑
  - 优化标题和按钮大小，移动端更易点击
  - 优化表单元素布局，移动端单列显示
  - 优化保存按钮，移动端全宽显示

### 🔧 技术优化

#### 数据库查询优化
- 🗄️ **智能数据库查询**：根据数据库类型选择相应的查询语句
  - 使用 `getDatabaseType()` 方法检测数据库类型（PostgreSQL 或 SQLite）
  - 根据类型直接使用对应的查询语句，避免先执行错误查询
  - 修复活跃时段分布查询：PostgreSQL 使用 `EXTRACT`，SQLite 使用 `strftime`
  - 修复群组增长趋势查询：根据数据库类型选择对应的 `DATE`/`date` 函数
  - 减少错误日志，提升查询性能

#### 导航栏组件重构
- 🎨 **导航栏样式完全重写**：
  - 移除左侧导航栏激活状态的蓝色边框（`.border-l-4 .border-primary`）
  - 重写所有导航栏样式，使用 CSS 类选择器精确控制激活状态
  - 顶部导航栏：激活时蓝色背景 + 白色文字
  - 左侧导航栏：激活时半透明蓝色背景 + 主色文字
  - 移动端导航栏：与左侧导航栏相同的样式
  - 使用 `:not(.active)` 选择器明确区分激活和非激活状态
  - 使用 `!important` 确保激活状态样式优先级
- ⚡ **样式清除逻辑优化**：
  - 优化 `updateActive()` 方法，简化激活状态更新逻辑
  - 移除不必要的 `data-active` 属性操作
  - 直接使用 `active` 类控制样式，由 CSS 统一管理
  - 提升性能，减少 DOM 操作
- 🔄 **路由切换修复**：
  - 修复路由切换时激活状态不更新的问题
  - `router.js` 中统一调用 `navigation.updateActive()` 更新激活状态
  - 确保路由变化时导航栏激活状态正确切换
  - 修复导航栏渲染后激活状态不更新的问题

#### 用户管理页面优化
- 🔍 **搜索框重写**：
  - 重写用户管理搜索框，与群管理页面使用相同的样式和功能
  - 添加搜索清除按钮，支持一键清空搜索内容
  - 移除筛选下拉框，简化搜索栏界面
  - 统一搜索框样式：响应式 padding、背景色、边框等
  - 统一统计信息显示格式（"共 X 个用户"）
- 📊 **列表更新逻辑优化**：
  - 移除排序下拉框相关逻辑，默认按名称排序
  - 更新统计信息显示，使用与群管理一致的格式
  - 优化用户列表渲染逻辑

#### 系统设置页面移除
- 🗑️ **移除系统设置功能**：
  - 移除系统设置标签页（`tabSettings`）
  - 移除系统设置内容区域（`contentSettings`）
  - 删除 `AdminSettings.js` 模块文件
  - 移除 `updateSettingsStats()` 方法及其调用
  - 从标签页数组中移除 `'Settings'`
  - 清理所有系统设置相关的事件监听器和逻辑
  - 简化管理页面结构，专注于核心功能（概览、群管理、用户管理）

#### 代码整理和优化
- 🧹 **代码清理**：
  - 移除 `app.js` 中无用的 `updateNavbarActive()` 方法（旧兼容代码）
  - 移除 `Navigation.js` 中无用的 `getLinkType()` 方法
  - 移除 `renderNavLinks()` 中不必要的 `data-active` 属性
  - 简化 `updateActive()` 方法，直接更新 `active` 类
  - 统一使用 `requestAnimationFrame` 替代 `setTimeout`，提升性能
  - 移除重复的激活状态更新调用
  - 删除未使用的 `AdminSettings.js` 文件
  - 移除 `AdminOverview.js` 中无用的 `updateSettingsStats()` 方法
- 📦 **代码结构优化**：
  - 优化导航栏组件代码结构，提高可维护性
  - 统一激活状态更新流程：路由切换 → `router.handleRoute()` → `navigation.updateActive()`
  - 减少代码量，提升代码可读性
  - 整理 resources 文件夹，删除未使用的文件

### 🐛 问题修复

- ✅ 修复导航栏激活状态一直保持不切换的问题
  - 修复路由切换时激活状态不更新的问题
  - 确保 `router.handleRoute()` 正确调用 `navigation.updateActive()`
  - 修复导航栏渲染后激活状态不更新的问题
- ✅ 修复左侧导航栏激活状态样式冲突问题
  - 移除蓝色边框样式，避免视觉冲突
  - 统一使用半透明蓝色背景 + 主色文字的激活样式
- ✅ 修复样式清除逻辑问题
  - 优化样式清除逻辑，只清除状态相关的样式类
  - 避免影响其他样式（如布局、间距等）
- ✅ 修复用户管理搜索框样式不一致的问题
  - 重写搜索框，与群管理页面保持一致
  - 添加清除按钮功能
- ✅ 修复移动端搜索框被遮挡的问题
  - 优化搜索框位置，添加移动端顶部边距
  - 调整 z-index 层级，确保正确的显示顺序
- ✅ 修复移动端管理导航栏按钮被遮挡的问题
  - 调整导航栏和搜索框的 z-index 值
  - 确保正确的层级关系：主导航栏 > 管理导航栏 > 搜索框

---

## [3.1.1] - 2025-11-14

### ✨ 新增功能

#### 管理员命令增强
- 🔄 **刷新成就命令**：新增 `#刷新水群成就` 和 `#刷新全群水群成就` 命令
  - `#刷新水群成就`：刷新当前群组的所有显示成就
  - `#刷新全群水群成就`：刷新所有群组的所有显示成就
  - **新逻辑**：先卸下所有自动佩戴的成就，然后重新检查并自动佩戴符合条件的成就
  - 自动检查并卸下以下类型的错误成就：
    - 不存在的成就（成就定义已删除）
    - 未解锁的成就（用户未达成条件）
    - 所有自动佩戴的成就（重新检查后会自动佩戴符合条件的）
  - 保留有效的手动设置成就（不卸下）
  - 重新自动佩戴史诗及以上成就（使用解锁时间+24小时）
  - 支持全局成就检查（特殊成就和节日成就）
  - 使用合并转发消息返回结果，信息更清晰
  - 显示详细的统计信息（已处理用户、已卸下、已自动佩戴、错误信息）
  - 仅管理员可用

### 🔧 技术优化

#### 自动佩戴和卸下逻辑重写
- ⏰ **自动佩戴逻辑优化**：
  - 史诗及以上成就自动佩戴时，使用解锁时间（`unlocked_at`）作为 `auto_display_at`
  - 24小时从解锁时间开始计算：解锁时间 + 24小时 = 卸下时间
  - 使用 UTC+8 时区统一计算，确保时间准确
  - 全局成就（特殊成就和节日成就）在一个群获取后，自动同步到所有群
  - 新解锁的更高稀有度成就会自动替换已自动佩戴的成就
- ⏰ **自动卸下逻辑优化**：
  - 使用 `auto_display_at`（即解锁时间）+ 24小时来判断是否过期
  - 修复时区计算问题，统一使用 UTC+8 时区
  - 支持 PostgreSQL 和 SQLite 两种数据库的日期格式（Date 对象和字符串）
  - 手动设置的成就不显示卸下时间，也不自动卸下
- 🔄 **刷新成就命令优化**：
  - 先卸下所有自动佩戴的成就（保留手动设置的成就）
  - 重新检查所有用户，自动佩戴符合条件的史诗及以上成就
  - 使用解锁时间作为 `auto_display_at`，确保24小时计时正确
  - 全局成就自动在所有群同步佩戴

#### 前端性能优化
- ⚡ **首页加载速度优化**：
  - 先显示基础统计数据，不等待排名和占比计算
  - 排名异步加载，使用分批查找策略（从1000名开始，逐步增加）
  - 消息占比延迟100ms加载，不阻塞页面显示
  - 群列表和统计数据并行加载
- ⚡ **排行榜页面优化**：
  - 群列表和排行榜数据并行加载
  - 事件监听器立即设置，不阻塞页面显示
- ⚡ **成就页面优化**：
  - 身份验证和群列表并行加载
  - 优化加载动画，减少不必要的等待时间

#### 消息返回格式优化
- 📨 **合并转发消息**：刷新成就命令使用合并转发消息返回结果
  - 单个群组刷新：统计信息和错误信息分条显示
  - 全群刷新：总体统计、群组详情和错误信息分条显示
  - 每条消息最多显示10个群组或10个错误，避免消息过长
  - 非群聊自动降级为普通文本消息

### 🐛 问题修复

- ✅ 修复自动佩戴成就24小时计时不准确的问题
  - 重写自动佩戴逻辑，使用解锁时间作为 `auto_display_at`
  - 修复时区计算问题，统一使用 UTC+8 时区
  - 确保24小时从解锁时间开始计算，不会因为后续操作而重置
- ✅ 修复自动卸下逻辑的时区问题
  - 修复 `checkAndRemoveExpiredAutoDisplay` 方法中的时区计算错误
  - 支持 PostgreSQL 和 SQLite 两种数据库的日期格式
  - 统一使用 UTC+8 时区进行时间计算
- ✅ 修复全局成就自动佩戴问题
  - 全局成就（特殊成就和节日成就）在一个群获取后，自动同步到所有群
  - 确保全局成就在所有群都正确显示
- ✅ 修复刷新成就命令不卸下错误成就的问题
  - 重写刷新逻辑，先卸下所有自动佩戴的成就
  - 重新检查并自动佩戴符合条件的成就
  - 确保使用解锁时间+24小时正确计算卸下时间
- ✅ 修复秘钥更新后本地存储不更新的问题
  - 保存新秘钥后，清除 sessionStorage 中的验证状态
  - 确保下次验证时使用新秘钥
- ✅ 修复秘钥验证逻辑问题
  - 修复 API 返回格式解析错误（`result.secretKey` → `result.data.secretKey`）
  - 支持两种 API 返回格式：`{ secretKey: ... }` 和 `{ success: true, data: { secretKey: ... } }`
  - 使用时间戳标记机制，避免服务器同步延迟导致的误报
  - 更新后1分钟内跳过验证，避免立即验证失败
- ✅ 修复 `autoDisplayAtStr.split is not a function` 错误
  - PostgreSQL 返回的 `auto_display_at` 是 Date 对象，而非字符串
  - 添加类型检查，支持 Date 对象和字符串两种类型
  - SQLite 返回字符串，PostgreSQL 返回 Date 对象，统一处理逻辑
- ✅ 修复首页加载速度慢的问题
  - 优化排名获取策略，避免一次性加载所有用户数据
  - 先显示基础数据，排名和占比异步加载
- ✅ 修复其他页面加载速度问题
  - 优化并行加载逻辑，减少等待时间
- ✅ 修复刷新成就命令重新自动佩戴过期成就的问题
  - 在自动选择成就时检查是否过期（解锁时间+24小时）
  - 只自动佩戴未过期的成就
  - 在 `getUserAchievements` 中也添加过期检查，避免查询时自动设置过期成就
- ✅ 修复成就配置文件监听重复启动的问题
  - 使用静态变量确保全局只有一个监听器
  - 避免多个 `AchievementService` 实例重复启动监听
- ✅ 修复 `globalConfig.info is not a function` 错误
  - 使用 `global.logger.mark()` 替代 `globalConfig.info()`
- ✅ 增强删除操作的验证和日志
  - 删除后验证是否成功
  - 添加详细的成功/失败日志

#### 隐私保护优化
- 🔒 **群号隐私化处理**：刷新成就命令返回消息中的群号进行隐私化处理
  - 使用 `CommonUtils.maskGroupId()` 方法隐藏群号中间部分
  - 保护群组隐私信息

#### 权限系统重构
- 🔐 **统一权限管理**：
  - 创建 `PermissionManager` 统一管理所有权限检查逻辑
  - 统一命令系统和 Web API 的权限验证
  - 权限优先级：1. Yunzai 系统主人 (e.isMaster) 2. key.json 中的 admin 角色
  - 命令系统现在也支持 key.json 的角色系统（之前只检查 e.isMaster）
  - Web API 和命令系统使用相同的权限检查逻辑
- 🔒 **key.json 安全优化**：
  - 移除明文秘钥存储（`originalKey` 字段），只保留 hash 和 salt
  - 创建 `KeyFileOptimizer` 工具类，自动清理现有文件中的明文秘钥
  - 插件启动时自动优化 key.json 文件
  - 保存和更新秘钥时自动移除 `originalKey` 字段
  - 提高安全性，防止秘钥泄露
- 🔧 **权限检查优化**：
  - `CommonUtils.validateAdminPermission()` 现在支持异步，内部使用 `PermissionManager`
  - `CommandWrapper.validateAndReply()` 支持异步验证
  - 所有管理员命令统一使用新的权限检查逻辑
  - Web API 中间件使用统一的权限管理器

#### 代码整理和优化
- 🧹 **代码清理**：
  - 移除重复的滚动条样式定义（`.page-content` 滚动条样式）
  - 移除无用的 Fabric.js 相关样式（已改用 cropperjs）
  - 移除未使用的 `.sidebar` 组件样式（使用 Tailwind CSS 类）
  - 移除重复的响应式规则（`@media (max-width: 1024px)`）
  - 合并重复的 CSS 选择器（Cropper.js 深色模式 `.cropper-point`）
  - 清理无用注释和空行
  - **移除所有调试日志**：清理 `resources` 目录下所有 `console.log` 和 `console.debug` 调试日志
    - 清理 `app.js`、`api.js`、`utils.js` 中的所有调试日志
    - 清理 `Home.js`、`Admin.js`、`Achievement.js` 等页面文件中的调试日志
    - 保留 `console.error` 和 `console.warn` 用于错误和警告提示
    - 提升生产环境代码整洁度，减少控制台输出
- 📦 **代码优化**：
  - 统一版本号：`package.json` 版本更新为 `3.1.1`
  - 优化代码结构，提高可维护性
  - 减少代码量约 200+ 行
  - 提升代码可读性和一致性

### 📝 文档更新

- ✅ 更新 README.md，添加刷新成就命令说明
- ✅ 更新 CHANGELOG.md，记录 3.1.1 版本的所有更新（包括代码清理和日志移除）
- ✅ 更新 package.json 版本号为 3.1.1

---

## [3.1.0] - 2025-11-11

### ✨ 新增功能

#### 数据库支持扩展
- 🗄️ **SQLite 数据库支持**：新增 SQLite 数据库适配器，支持双数据库选择
  - 支持 PostgreSQL（默认，生产环境推荐）
  - 支持 SQLite（小型部署推荐，无需安装数据库服务器）
  - 通过配置 `database.type` 选择数据库类型
  - **SQLite 路径配置优化**：支持直接写文件名，自动拼接插件 data 目录
    - 只写文件名（如 `"speech_statistics.db"`）：自动放在插件 `data` 目录下
    - 相对路径（如 `"data/my.db"`）：相对于插件目录
    - 绝对路径：直接使用该路径
    - 不指定 `path`：默认使用 `speech_statistics.db`（在插件 `data` 目录下）
  - SQLite 数据库文件默认位置：`plugins/Speaker-statistics-plugin/data/speech_statistics.db`
  - 自动适配占位符、数据类型、事务等差异
  - 支持 WAL 模式，提高并发性能
  - `better-sqlite3` 设为可选依赖，仅在使用 SQLite 时需要安装

#### 数据库架构优化
- 🏗️ **适配器模式架构**：采用数据库适配器模式，实现数据库抽象层
  - `BaseAdapter`：定义统一数据库接口
  - `PostgreSQLAdapter`：PostgreSQL 适配器实现
  - `SQLiteAdapter`：SQLite 适配器实现
  - `DatabaseService`：根据配置自动选择适配器
  - 所有业务代码无需修改，自动适配不同数据库

#### 配置界面增强
- ⚙️ **Guoba 配置界面更新**：数据库配置界面支持 SQLite
  - 添加数据库类型选择器（PostgreSQL/SQLite）
  - 添加 SQLite 数据库路径配置项（支持直接写文件名）
  - PostgreSQL 配置项标记为可选（仅 PostgreSQL 需要）
  - 配置项说明更清晰，标注适用场景
- ⚙️ **配置文件模板更新**：
  - 更新 `config/configTemplate.js`，添加 `database.type` 和 `database.path` 字段说明
  - 更新 `data/global.json`，添加 `type` 字段（默认 `postgresql`）
  - SQLite 路径配置支持简化写法（直接写文件名）

#### 插件更新功能
- 🔄 **插件更新命令**：新增 `#水群更新` 和 `#水群强制更新` 命令
  - `#水群更新`：普通更新插件（执行 `git pull`）
  - `#水群强制更新`：强制更新插件（重置到远程分支，覆盖本地修改）
  - 自动检测是否已是最新版本
  - 自动检测依赖变更，提示是否需要重新安装依赖
  - **自动重启功能**：更新成功后自动重启插件以应用更新
    - 直接调用系统 `restart.js` 模块，使用标准重启流程
    - 自动保存重启信息到 Redis（持久化存储）
    - 重启前延迟1秒，确保更新消息发送成功
    - 如果自动重启失败，会提示用户手动重启
  - **重启完成提示**：重启完成后自动发送提示消息
    - 使用系统标准重启流程，自动发送重启完成提示
    - 优先发送到原群聊，失败则发送给主人
    - 提示消息包含重启用时和完成状态
  - 仅管理员可用

#### 成就系统优化
- ⏰ **自动卸下时间显示**：成就页面显示自动佩戴成就的卸下时间
  - 显示剩余时间（X小时Y分钟后）
  - 过期时显示"即将自动卸下"提示
  - 仅对自动佩戴的成就显示（手动设置的成就无时限）
  - **位置优化**：自动卸下时间显示在成就名称下方，更醒目易读
  - 使用蓝色文字和加粗样式，提升视觉效果
- 🔧 **24小时计时优化**：修复自动佩戴成就的24小时计时逻辑
  - 24小时从成就获取时间开始计算，不会因为后续操作而重置
  - 避免重复设置自动显示成就时重置计时器
  - 优化自动设置逻辑，仅在没有任何显示成就时才自动设置
- 🕐 **时区计算修复**：修复成就自动卸下功能的时区问题
  - 修复 `checkAndRemoveExpiredAutoDisplay` 方法中的时区计算错误
  - 统一使用 UTC+8 时区进行时间计算，确保24小时计时准确
  - 修复前端页面时区计算，确保显示剩余时间准确
  - 修复模板渲染中的时区计算，确保所有时间显示一致
  - 解决因时区问题导致第二天成就重新佩戴的问题

### 🔧 技术优化

#### 数据库架构重构
- ✅ **适配器模式实现**：
  - 创建 `BaseAdapter` 基类，定义统一数据库接口
  - 重构 `DatabaseService` 为适配器选择器
  - 实现 `PostgreSQLAdapter` 和 `SQLiteAdapter`
  - 所有业务逻辑方法保持不变，自动适配不同数据库
- ✅ **SQL 兼容性处理**：
  - 自动转换占位符（`$1, $2...` ↔ `?`）
  - 自动映射数据类型（VARCHAR→TEXT, BIGINT→INTEGER, BOOLEAN→INTEGER）
  - 统一 UPSERT 语法（`ON CONFLICT ... DO UPDATE`）
  - 适配数据库大小查询（PostgreSQL: `pg_database_size()`, SQLite: `pragma_page_*`）
- ✅ **连接管理优化**：
  - PostgreSQL：使用连接池（Pool）
  - SQLite：使用单连接，支持 better-sqlite3 和 sqlite3 两种驱动
  - SQLite 自动启用 WAL 模式，提高并发性能
- ✅ **依赖管理优化**：
  - `better-sqlite3` 设为可选依赖（`optionalDependencies`）
  - 仅在使用 SQLite 时需要安装，使用 PostgreSQL 时无需安装
  - 未安装 SQLite 驱动时给出清晰的错误提示
  - 更新 `better-sqlite3` 版本至 `^12.4.1`（最新稳定版）
  - 确保在 Linux 和 Windows 系统上都能正常安装
- ✅ **依赖错误处理优化**：
  - **sharp 模块错误处理**：动态导入 sharp，避免模块加载时失败
    - 在需要使用 sharp 时才尝试加载
    - 加载失败时返回清晰的错误提示和解决方案
    - 提示安装 Windows 构建工具（Windows Build Tools 或 Visual Studio Build Tools）
  - **better-sqlite3 bindings 错误处理**：检测 bindings 文件缺失错误
    - 提供详细的解决方案（重新安装、安装构建工具、回退到 sqlite3）
    - 自动尝试回退到 sqlite3（如果 better-sqlite3 失败）
    - 错误提示包含原始错误信息，便于调试

#### 代码重构
- ✅ **API响应格式统一**：修复所有API的响应格式，统一使用 `ApiResponse.success()` 和 `ApiResponse.error()`
- ✅ **秘钥验证修复**：修复前端秘钥验证逻辑，正确解析API响应格式
  - 修复 `validation.valid` 应为 `response.data.valid` 的问题
  - 验证成功时显示成功提示（绿色），而非错误提示
- ✅ **重启功能优化**：使用系统标准重启流程
  - 直接调用系统 `restart.js` 模块，复用标准重启逻辑
  - 使用 Redis 存储重启信息（持久化，支持跨进程）
  - 自动发送重启完成提示消息
  - 简化代码，移除自定义重启逻辑
- ✅ **代码重构优化**：创建 `CommandWrapper` 工具类
  - 统一验证和错误处理逻辑，减少重复代码
  - `validateAndReply()`：统一验证并回复模式
  - `safeExecute()`：统一异步操作的错误处理
  - 重构 `AdminCommands.js`，使用 CommandWrapper 简化代码
  - 优化 `toggleSetting()` 方法，使用映射表替代 switch 语句
- ✅ **代码清理**：
  - 移除重复的代码逻辑
  - 统一群名称格式化方法（`getFormattedGroupName`）
  - 提取重复的Token验证逻辑
  - 清理未使用的导入和代码
  - 每个命令方法减少约 5-10 行重复代码

#### 数据库优化
- ✅ **自动显示成就逻辑优化**：
  - 保留已存在自动显示成就的 `auto_display_at` 时间，不重置24小时计时
  - 仅在首次自动设置时设置 `auto_display_at`
  - 避免重复设置时重置计时器

#### 前端优化
- ✅ **成就页面数据解析修复**：修复成就列表API响应格式解析问题
  - 正确解析 `response.data.achievements` 数组
  - 正确获取 `response.data.current_display` 和 `response.data.display_info`
- ✅ **成就页面UI优化**：优化自动卸下时间显示位置和样式
  - 将自动卸下时间从卡片底部移至成就名称下方
  - 使用蓝色文字和加粗样式，提升可读性
  - 优化间距和布局，使信息层次更清晰
- ✅ **响应式设计优化**：优化移动端显示效果

### 🐛 问题修复

- ✅ 修复成就页面 `this.achievements is not iterable` 错误
- ✅ 修复秘钥验证成功但显示错误图标的问题
- ✅ 修复自动佩戴成就24小时计时被重置的问题
- ✅ 修复成就页面数据不显示的问题（API响应格式解析错误）
- ✅ 修复自动设置成就时重复设置导致计时器重置的问题
- ✅ 修复 sharp 模块在 Windows 上安装失败导致插件无法加载的问题
- ✅ 修复 better-sqlite3 bindings 文件缺失时错误提示不清晰的问题
- ✅ 优化依赖安装失败时的错误提示，提供详细的解决方案
- ✅ 修复成就自动卸下功能的时区计算问题（使用 UTC+8 时区统一计算）
- ✅ 修复前端页面时区计算，确保剩余时间显示准确
- ✅ 修复模板渲染中的时区计算，确保时间显示一致

### 📝 文档更新

- ✅ 更新 README.md，添加 SQLite 数据库支持说明
- ✅ 更新安装步骤，说明 SQLite 驱动的可选安装
- ✅ 更新配置说明，添加 SQLite 配置示例
- ✅ 更新 Guoba 配置界面，支持数据库类型选择
- ✅ 优化安装说明，明确 `better-sqlite3` 已包含在依赖中，无需额外安装
- ✅ 更新安装提示，说明自动回退机制和错误处理

---

## [3.0.2] - 2025-11-06

### ✨ 新增功能

#### Web管理界面
- 🌐 **Web管理界面**：基于Express的Web服务器
  - 用户统计页面：查看个人发言统计
  - 排行榜页面：查看群聊排名
  - 成就页面：查看和管理成就
  - 背景设置页面：上传和设置背景图片
  - 设置页面：用户设置和秘钥管理
  - 管理页面：管理员功能（概览、群管理、用户管理）

#### 移动端适配
- 📱 **响应式设计**：所有页面完全适配移动端
  - 移动端导航菜单
  - 响应式布局（Grid/Flexbox）
  - 移动端优化的卡片和列表
  - 触摸友好的交互

#### 网页功能增强
- 🌐 **Token访问系统**：通过QQ命令生成Token链接，安全访问个人页面
  - `#水群网页`：生成个人统计页面链接
  - `#水群设置背景`：生成背景设置页面链接
  - Token自动验证身份，设置Cookie
- 🔗 **URL优化**：隐藏用户ID，使用Token替代URL参数
- 🎨 **页面美化**：
  - 首页优化：移除快速操作，优化卡片排序
  - 排行榜优化：统一列表样式，移动端卡片布局
  - 成就页面优化：切换群聊不闪烁，显示已佩戴状态
  - 背景设置页面优化：Fabric.js集成，图片编辑功能

#### 设置页面
- ⚙️ **用户设置页面**：全新的设置界面
  - 用户信息：显示用户ID和用户名，支持修改用户ID
  - 安全设置：秘钥管理（设置/修改/清除），支持验证码验证
  - 数据管理：清除本地缓存、重置所有设置
  - 关于信息：系统名称和版本

#### 秘钥管理增强
- 🔐 **验证码系统**：
  - 修改/移除秘钥需要验证码
  - 验证码通过机器人私信发送
  - 验证码有效期1分钟
  - 发送后按钮禁用并显示倒计时

#### 管理页面增强
- 🎯 **管理页面重构**：全新的管理界面，采用左右分栏布局
- 📊 **群管理功能增强**：
  - 左侧群聊列表卡片式选择
  - 右侧显示群详情和管理功能
  - 群内用户排名显示（前10名，带奖牌图标🥇🥈🥉）
  - 刷新统计数据功能
  - 清除群统计数据功能
- 👥 **用户管理功能增强**：
  - 左侧用户列表卡片式选择
  - 右侧显示用户详情
  - 查看用户所在的所有群聊（显示每个群的消息数、字数、排名）
  - 用户基本信息展示（用户ID、角色、所在群数、总消息数、总字数、创建时间、更新时间）
  - 网页界面支持修改用户权限（user ↔ admin）
  - 清除用户数据功能（待实现后端API）
- 📈 **概览页面优化**：
  - 显示总群数、总用户数、总消息数
  - 热门群聊列表（显示群名而非群号）
  - 优化数据展示格式

#### 身份验证优化
- 🔒 **验证状态管理**：使用 `sessionStorage` 记录验证状态，避免重复验证
- 🎫 **Token访问优化**：通过QQ命令链接访问时，仅在第一次打开时验证身份
- 🛡️ **页面级验证**：
  - 管理页面：每次刷新不弹窗，使用会话验证状态
  - 背景设置页面：进入页面时验证身份
  - 成就设置页面：进入页面时验证身份

### 🔧 技术优化

- ✅ **Web服务器**：`WebServer.js` 统一管理Web服务
- ✅ **API路由**：RESTful API设计
- ✅ **前端框架**：原生JavaScript + Tailwind CSS
- ✅ **路由系统**：Hash路由，单页应用
- ✅ **API统一化**：所有API调用统一使用 `ApiResponse` 工具类
- ✅ **中间件系统**：创建 `AuthMiddleware` 统一处理认证和参数验证
- ✅ **服务拆分**：
  - `BackgroundServer.js` 重构为 `WebServer.js`
  - 拆分认证服务：`TokenManager.js`、`VerificationCodeManager.js`、`AuthService.js`
  - 拆分API路由：`AuthApi.js`、`StatsApi.js`、`RankingApi.js`、`AchievementApi.js`、`BackgroundApi.js`、`AdminApi.js`
  - 创建 `PageRoutes.js` 处理页面路由
- ✅ **工具类优化**：
  - `SecretKeyManager`：统一秘钥管理逻辑
  - `WebLinkGenerator`：统一链接生成逻辑
  - 移除重复代码，提高可维护性
- ✅ **数据库优化**：
  - 角色权限系统：`key.json` 支持 `role` 字段（admin/user）
  - Token系统：8位Token替代64位，简化URL
- ✅ **前端优化**：
  - 组件化设计：Modal、Toast等可复用组件
  - 事件委托：优化动态元素事件绑定
  - Toast提示优化：Toast提示条幅置顶显示（桌面端距离顶部20px，移动端10px），z-index提升至99999，确保在所有元素之上显示
  - 用户管理页面优化：添加用户统计信息、优化群聊列表显示、美化滚动条样式
  - 首页数据聚合：选择"全部群聊"时自动聚合所有群聊的统计数据
  - 权限管理增强：网页管理界面支持修改用户权限

### 🐛 问题修复

- ✅ 修复管理页面每次刷新都弹窗验证的问题
- ✅ 修复背景设置和成就页面缺少身份验证的问题
- ✅ 修复Token访问时重复验证的问题
- ✅ 修复移动端Toast提示位置和消失问题
- ✅ 修复移动端下拉菜单样式问题
- ✅ 修复成就页面切换称号和显示状态的问题
- ✅ 修复管理页面概览显示群号而非群名的问题
- ✅ 修复用户管理显示用户ID而非用户名的问题
- ✅ 修复服务器重复启动的问题
- ✅ 修复ES模块导入错误（`require` → `import`）
- ✅ 修复新用户创建时默认角色问题（默认role为'user'）
- ✅ 修复key.json空文件导致的JSON解析错误
- ✅ 修复群内用户排名数据不显示的问题（字段映射错误）
- ✅ 修复首页选择"全部群聊"时数据不聚合的问题
- ✅ 修复用户管理页面群聊列表数据不显示的问题

---

## [3.0.0] - 2025-11-04

### ✨ 新增功能

#### 成就系统增强
- 🎯 **Guoba-Plugin 集成**：支持通过网页界面配置插件，可视化管理成就和配置
- 🏆 **成就系统重构**：17种成就类型，支持周/月统计、文本匹配、时间窗口条件
- 🌈 **成就稀有度系统**：7种稀有度（普通、不普通、稀有、史诗、传说、神话、节日）
- 👥 **群专属成就支持**：为特定群组创建专属成就，实现个性化成就系统
- 🎊 **节日成就不重复获取**：节日成就在一个群内达成后，自动同步到所有群，避免重复记录
- 📊 **成就列表优化**：图片化显示所有成就，支持已解锁/未解锁状态，按稀有度和解锁时间排序
- ⭐ **智能显示优化**：自动优先显示史诗及以上稀有度成就（包含史诗、传说、节日）

#### 查询功能增强
- 🔍 **查询他人功能**：支持通过 `@` 查询其他用户的统计信息（`#水群查询 @用户`）
- 📈 **个人统计优化**：
  - 显示群个数、消息占比等详细数据
  - 优化卡片布局：今日发言占两列，平均每日发言放在消息占比边上
  - 移除重复显示的统计数据，提升用户体验

#### 成就系统增强（补充）
- ⏰ **自动佩戴成就时限**：自动佩戴的成就仅显示24小时，24小时后自动卸下
- 🔧 **手动设置无时限**：使用 `#水群设置显示成就` 手动设置的成就无时限，永久显示
- 📊 **成就统计功能**：新增 `#水群成就统计` 命令，查看每个成就的获取情况
  - 全局成就统计所有群的获取人数
  - 群专属成就仅统计当前群的获取人数
  - 按获取人数降序排序，获取人数相同时按稀有度排序
- ✨ **特殊成就支持**：新增"特殊"（Special）稀有度等级，最高稀有度
- 🌍 **全局成就同步**：特殊成就和节日成就都不重复获取，获取后在任意群都显示为已获取

#### UI/UX 优化
- 🎨 **成就显示优化**：成就徽章从名字前缀改为末尾卡片式显示
- 📋 **成就列表分隔条**：已解锁和未解锁成就之间添加视觉分隔条
- 🎨 **模板优化**：所有 HTML 模板内容生成集中在 JS 中，提高可维护性
- 🎨 **配色方案优化**：全局统计页面采用黑白灰配色，移除渐变效果
- 🎨 **成就列表卡片优化**：
  - 优化卡片布局，使用 Grid 布局确保文字对齐
  - 徽章和文字分开，所有文字从固定位置开始
  - 状态图标优化，更精致美观
  - 改进卡片样式，增加阴影和渐变效果
  - 添加 hover 效果，提升交互体验
- 📊 **成就统计显示优化**：
  - 获取人数字体增大（22px → 30px），更易阅读
  - 使用图标 👥 表示获取人数
  - 横向布局，描述和获取人数在同一行显示

### 🔧 技术优化

#### 代码重构
- ✅ **统一工具类**：创建 `AchievementUtils.js` 工具类，统一稀有度配置和判断逻辑
  - 统一稀有度配置：`RARITY_ORDER`
  - 统一节日成就判断：`isFestivalAchievement()`
  - 统一成就排序：`sortUnlockedAchievements()`, `sortLockedAchievements()`
  - 统一稀有度比较：`isRarityOrHigher()`, `compareRarity()`
- ✅ **消除重复逻辑**：
  - 移除 `AchievementService.js`、`TemplateManager.js`、`AchievementCommands.js` 中重复的稀有度排序逻辑
  - 统一使用 `AchievementUtils` 工具类
- ✅ **模板优化**：所有动态 HTML 内容生成集中在 JS 中（`TemplateManager.js`）
  - `userStatsTemplate.html` - 用户统计模板
  - `achievementListTemplate.html` - 成就列表模板
  - `globalStatsTemplate.html` - 全局统计模板
  - `groupStatsTemplate.html` - 群组统计模板
  - `imageRankingTemplate.html` - 排行榜模板

#### 数据库优化
- ✅ **PostgreSQL 存储**：使用 `pg` 数据库驱动，提升查询性能
- ✅ **连接池管理**：优化数据库连接，提高并发能力
- ✅ **节日成就同步**：新增 `saveFestivalAchievementToAllGroups()` 方法，批量同步节日成就到所有群
- ✅ **数据库字段扩展**：`user_display_achievements` 表新增 `is_manual` 和 `auto_display_at` 字段
  - `is_manual`：标识是否为手动设置的成就（手动设置无时限）
  - `auto_display_at`：自动佩戴的时间戳（用于计算24小时时限）
- ✅ **数据库迁移**：自动检测并添加新字段，支持平滑升级

#### 代码优化
- ✅ **成就工具类扩展**：
  - 新增 `isSpecialAchievement()` 方法判断特殊成就
  - 新增 `isGlobalAchievement()` 方法判断全局成就（特殊成就或节日成就）
  - 统一全局成就的处理逻辑
- ✅ **成就服务优化**：
  - 新增 `checkAndRemoveExpiredAutoDisplay()` 方法，自动检查并卸下过期成就
  - 优化自动选择显示成就逻辑，设置24小时时限
  - 统一全局成就的检查和同步逻辑
- ✅ **数据库服务扩展**：
  - 新增 `getAchievementUnlockCount()` 方法，统计成就获取人数
  - 支持全局成就和群专属成就的分别统计
- ✅ **动态路径解析**：完全消除硬编码路径，提高可移植性
- ✅ **配置热重载**：支持配置修改后自动重载
- ✅ **单例模式统一**：统一核心服务的单例实现，避免状态重复
- ✅ **UTC+8 时区**：所有时间操作统一使用 UTC+8 时区
- ✅ **数据去重**：移除重复显示的统计数据，优化用户体验

### 🐛 问题修复

- ✅ 修复日志重复输出问题
- ✅ 修复时区不一致问题
- ✅ 修复成就解锁重复提醒
- ✅ 修复成就查询数据错误（PostgreSQL 布尔类型判断）
- ✅ 修复成就显示数据错误（`unlocked === 1` 改为 `unlocked === true`）
- ✅ 修复群组名称显示问题（优先从数据库获取，支持从 Bot 内存获取）
- ✅ 修复排行榜分页问题（支持后续页面查询）
- ✅ 修复成就设置显示时的参数错误（`achievement_id`/`achievement_name` 改为 `id`/`name`）
- ✅ 修复全局统计用户数重复计算问题（`#水群总统计` 中用户数现在使用 Set 去重，确保跨群用户不重复计算）
- ✅ 修复 Guoba-Plugin 集成中群专属成就路径错误（`getConfigData.js` 和 `setConfigData.js` 中路径从 `config/achievements/group` 更新为 `data/achievements/group`）
- ✅ 修复成就列表显示时徽章被截断的问题
- ✅ 修复成就列表文字不对齐的问题（徽章宽度不一致导致）

### 🔧 配置优化

#### 目录结构优化
- ✅ **成就配置目录迁移**：将用户自定义成就配置目录从 `config/achievements` 迁移到 `data/achievements`
  - 系统默认成就已重构为 `config/achievements/` 目录结构，按分类分文件存储（41个成就，只读）
  - 用户自定义成就现在存放在 `data/achievements/` 目录下
  - 群专属成就现在存放在 `data/achievements/group/{群ID}/` 目录下
  - 更符合数据与配置的分离原则，便于版本控制和数据管理
  - 更新相关代码路径：`AchievementService.js`、`getConfigData.js`、`setConfigData.js`
- ✅ **Git 忽略规则优化**：精确控制 `.gitignore`，确保用户配置不被提交，但保留 README.md 文档

### 📝 文档更新

- ✅ 更新 README.md，添加新功能说明
- ✅ 创建 CHANGELOG.md，详细记录所有更新内容
- ✅ 添加 Gitee 仓库链接
- ✅ 更新成就配置说明文档路径（`data/achievements/README.md`）

---

## [2.x.x] - 历史版本

> 注：v2.x 版本及之前的历史变更记录未详细记录。

---

## 版本说明

- **主版本号（Major）**：不兼容的 API 变更
- **次版本号（Minor）**：向后兼容的功能新增
- **修订版本号（Patch）**：向后兼容的问题修复

---

## 贡献指南

如果你发现文档中缺少某项更新，欢迎提交 Issue 或 Pull Request 来完善本文档。

