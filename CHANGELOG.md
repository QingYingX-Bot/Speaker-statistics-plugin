# 📝 更新日志 (Changelog) by:AI

本文档记录了插件的所有重要变更。

---

## [3.0.5] - 2025-11-06

### ✨ 新增功能

#### 管理页面增强
- 🎯 **管理页面重构**：全新的管理界面，采用左右分栏布局
- 📊 **群管理功能增强**：
  - 左侧群聊列表卡片式选择
  - 右侧显示群详情和管理功能
  - 群内用户排名显示（前10名，带奖牌图标🥇🥈🥉）
  - 刷新统计数据功能
  - 清除群统计数据功能
- 👥 **用户管理功能增强**：
  - 左侧用户列表卡片式选择
  - 右侧显示用户详情
  - 查看用户所在的所有群聊
  - 用户基本信息展示（用户ID、角色、所在群数）
  - 清除用户数据功能（待实现后端API）
- 📈 **概览页面优化**：
  - 显示总群数、总用户数、总消息数
  - 热门群聊列表（显示群名而非群号）
  - 优化数据展示格式

#### 身份验证优化
- 🔒 **验证状态管理**：使用 `sessionStorage` 记录验证状态，避免重复验证
- 🎫 **Token访问优化**：通过QQ命令链接访问时，仅在第一次打开时验证身份
- 🛡️ **页面级验证**：
  - 管理页面：每次刷新不弹窗，使用会话验证状态
  - 背景设置页面：进入页面时验证身份
  - 成就设置页面：进入页面时验证身份
- 🔐 **验证码系统**：敏感操作（修改/移除秘钥）需要验证码验证

### 🔧 技术优化

#### 代码重构
- ✅ **API统一化**：所有API调用统一使用 `ApiResponse` 工具类
- ✅ **中间件系统**：创建 `AuthMiddleware` 统一处理认证和参数验证
- ✅ **服务拆分**：
  - `BackgroundServer.js` 重构为 `WebServer.js`
  - 拆分认证服务：`TokenManager.js`、`VerificationCodeManager.js`、`AuthService.js`
  - 拆分API路由：`AuthApi.js`、`StatsApi.js`、`RankingApi.js`、`AchievementApi.js`、`BackgroundApi.js`、`AdminApi.js`
  - 创建 `PageRoutes.js` 处理页面路由
- ✅ **工具类优化**：
  - `SecretKeyManager`：统一秘钥管理逻辑
  - `WebLinkGenerator`：统一链接生成逻辑
  - 移除重复代码，提高可维护性

#### 数据库优化
- ✅ **角色权限系统**：`key.json` 支持 `role` 字段（admin/user）
- ✅ **Token系统**：8位Token替代64位，简化URL

#### 前端优化
- ✅ **单页应用路由**：Hash路由，无需刷新页面
- ✅ **组件化设计**：Modal、Toast等可复用组件
- ✅ **事件委托**：优化动态元素事件绑定

### 🐛 问题修复

- ✅ 修复管理页面每次刷新都弹窗验证的问题
- ✅ 修复背景设置和成就页面缺少身份验证的问题
- ✅ 修复Token访问时重复验证的问题
- ✅ 修复移动端Toast提示位置和消失问题
- ✅ 修复移动端下拉菜单样式问题
- ✅ 修复成就页面切换称号和显示状态的问题
- ✅ 修复管理页面概览显示群号而非群名的问题
- ✅ 修复用户管理显示用户ID而非用户名的问题
- ✅ 修复服务器重复启动的问题
- ✅ 修复ES模块导入错误（`require` → `import`）

---

## [3.0.4] - 2025-11-06

### ✨ 新增功能

#### 网页功能增强
- 🌐 **Token访问系统**：通过QQ命令生成Token链接，安全访问个人页面
  - `#水群网页`：生成个人统计页面链接
  - `#水群设置背景`：生成背景设置页面链接
  - Token自动验证身份，设置Cookie
- 🔗 **URL优化**：隐藏用户ID，使用Token替代URL参数
- 🎨 **页面美化**：
  - 首页优化：移除快速操作，优化卡片排序
  - 排行榜优化：统一列表样式，移动端卡片布局
  - 成就页面优化：切换群聊不闪烁，显示已佩戴状态
  - 背景设置页面优化：Fabric.js集成，图片编辑功能

### 🔧 技术优化

- ✅ **路由系统**：`PageRoutes.js` 处理Token验证和页面路由
- ✅ **Token管理**：`TokenManager.js` 管理Token生成、验证和消费
- ✅ **链接生成**：`WebLinkGenerator.js` 统一生成Token链接

---

## [3.0.3] - 2025-11-06

### ✨ 新增功能

#### 设置页面
- ⚙️ **用户设置页面**：全新的设置界面
  - 用户信息：显示用户ID和用户名，支持修改用户ID
  - 安全设置：秘钥管理（设置/修改/清除），支持验证码验证
  - 数据管理：清除本地缓存、重置所有设置
  - 关于信息：系统名称和版本

#### 秘钥管理增强
- 🔐 **验证码系统**：
  - 修改/移除秘钥需要验证码
  - 验证码通过机器人私信发送
  - 验证码有效期1分钟
  - 发送后按钮禁用并显示倒计时

### 🔧 技术优化

- ✅ **SecretKeyManager**：统一秘钥管理逻辑
- ✅ **VerificationCodeManager**：验证码生成和管理
- ✅ **Storage工具优化**：改进localStorage处理逻辑

---

## [3.0.2] - 2025-11-06

### ✨ 新增功能

#### 网页界面
- 🌐 **Web管理界面**：基于Express的Web服务器
  - 用户统计页面：查看个人发言统计
  - 排行榜页面：查看群聊排名
  - 成就页面：查看和管理成就
  - 背景设置页面：上传和设置背景图片
  - 设置页面：用户设置和秘钥管理
  - 管理页面：管理员功能（概览、群管理、用户管理）

#### 移动端适配
- 📱 **响应式设计**：所有页面完全适配移动端
  - 移动端导航菜单
  - 响应式布局（Grid/Flexbox）
  - 移动端优化的卡片和列表
  - 触摸友好的交互

### 🔧 技术优化

- ✅ **Web服务器**：`WebServer.js` 统一管理Web服务
- ✅ **API路由**：RESTful API设计
- ✅ **前端框架**：原生JavaScript + Tailwind CSS
- ✅ **路由系统**：Hash路由，单页应用

---

## [3.0.1] - 2025-11-04

### ✨ 新增功能

#### 成就系统增强
- ⏰ **自动佩戴成就时限**：自动佩戴的成就仅显示24小时，24小时后自动卸下
- 🔧 **手动设置无时限**：使用 `#水群设置显示成就` 手动设置的成就无时限，永久显示
- 📊 **成就统计功能**：新增 `#水群成就统计` 命令，查看每个成就的获取情况
  - 全局成就统计所有群的获取人数
  - 群专属成就仅统计当前群的获取人数
  - 按获取人数降序排序，获取人数相同时按稀有度排序
- ✨ **特殊成就支持**：新增"特殊"（Special）稀有度等级，最高稀有度
- 🌍 **全局成就同步**：特殊成就和节日成就都不重复获取，获取后在任意群都显示为已获取

#### UI/UX 优化
- 🎨 **成就列表卡片优化**：
  - 优化卡片布局，使用 Grid 布局确保文字对齐
  - 徽章和文字分开，所有文字从固定位置开始
  - 状态图标优化，更精致美观
  - 改进卡片样式，增加阴影和渐变效果
  - 添加 hover 效果，提升交互体验
- 📊 **成就统计显示优化**：
  - 获取人数字体增大（22px → 30px），更易阅读
  - 使用图标 👥 表示获取人数
  - 横向布局，描述和获取人数在同一行显示

### 🔧 技术优化

#### 数据库优化
- ✅ **数据库字段扩展**：`user_display_achievements` 表新增 `is_manual` 和 `auto_display_at` 字段
  - `is_manual`：标识是否为手动设置的成就（手动设置无时限）
  - `auto_display_at`：自动佩戴的时间戳（用于计算24小时时限）
- ✅ **数据库迁移**：自动检测并添加新字段，支持平滑升级

#### 代码优化
- ✅ **成就工具类扩展**：
  - 新增 `isSpecialAchievement()` 方法判断特殊成就
  - 新增 `isGlobalAchievement()` 方法判断全局成就（特殊成就或节日成就）
  - 统一全局成就的处理逻辑
- ✅ **成就服务优化**：
  - 新增 `checkAndRemoveExpiredAutoDisplay()` 方法，自动检查并卸下过期成就
  - 优化自动选择显示成就逻辑，设置24小时时限
  - 统一全局成就的检查和同步逻辑
- ✅ **数据库服务扩展**：
  - 新增 `getAchievementUnlockCount()` 方法，统计成就获取人数
  - 支持全局成就和群专属成就的分别统计

### 🐛 问题修复

- ✅ 修复成就列表显示时徽章被截断的问题
- ✅ 修复成就列表文字不对齐的问题（徽章宽度不一致导致）

---

## [3.0.0] - 2025-11-04

### ✨ 新增功能

#### 成就系统增强
- 🎯 **Guoba-Plugin 集成**：支持通过网页界面配置插件，可视化管理成就和配置
- 🏆 **成就系统重构**：17种成就类型，支持周/月统计、文本匹配、时间窗口条件
- 🌈 **成就稀有度系统**：7种稀有度（普通、不普通、稀有、史诗、传说、神话、节日）
- 👥 **群专属成就支持**：为特定群组创建专属成就，实现个性化成就系统
- 🎊 **节日成就不重复获取**：节日成就在一个群内达成后，自动同步到所有群，避免重复记录
- 📊 **成就列表优化**：图片化显示所有成就，支持已解锁/未解锁状态，按稀有度和解锁时间排序
- ⭐ **智能显示优化**：自动优先显示史诗及以上稀有度成就（包含史诗、传说、节日）

#### 查询功能增强
- 🔍 **查询他人功能**：支持通过 `@` 查询其他用户的统计信息（`#水群查询 @用户`）
- 📈 **个人统计优化**：
  - 显示群个数、消息占比等详细数据
  - 优化卡片布局：今日发言占两列，平均每日发言放在消息占比边上
  - 移除重复显示的统计数据，提升用户体验

#### UI/UX 优化
- 🎨 **成就显示优化**：成就徽章从名字前缀改为末尾卡片式显示
- 📋 **成就列表分隔条**：已解锁和未解锁成就之间添加视觉分隔条
- 🎨 **模板优化**：所有 HTML 模板内容生成集中在 JS 中，提高可维护性
- 🎨 **配色方案优化**：全局统计页面采用黑白灰配色，移除渐变效果

### 🔧 技术优化

#### 代码重构
- ✅ **统一工具类**：创建 `AchievementUtils.js` 工具类，统一稀有度配置和判断逻辑
  - 统一稀有度配置：`RARITY_ORDER`
  - 统一节日成就判断：`isFestivalAchievement()`
  - 统一成就排序：`sortUnlockedAchievements()`, `sortLockedAchievements()`
  - 统一稀有度比较：`isRarityOrHigher()`, `compareRarity()`
- ✅ **消除重复逻辑**：
  - 移除 `AchievementService.js`、`TemplateManager.js`、`AchievementCommands.js` 中重复的稀有度排序逻辑
  - 统一使用 `AchievementUtils` 工具类
- ✅ **模板优化**：所有动态 HTML 内容生成集中在 JS 中（`TemplateManager.js`）
  - `userStatsTemplate.html` - 用户统计模板
  - `achievementListTemplate.html` - 成就列表模板
  - `globalStatsTemplate.html` - 全局统计模板
  - `groupStatsTemplate.html` - 群组统计模板
  - `imageRankingTemplate.html` - 排行榜模板

#### 数据库优化
- ✅ **PostgreSQL 存储**：使用 `pg` 数据库驱动，提升查询性能
- ✅ **连接池管理**：优化数据库连接，提高并发能力
- ✅ **节日成就同步**：新增 `saveFestivalAchievementToAllGroups()` 方法，批量同步节日成就到所有群

#### 其他优化
- ✅ **动态路径解析**：完全消除硬编码路径，提高可移植性
- ✅ **配置热重载**：支持配置修改后自动重载
- ✅ **单例模式统一**：统一核心服务的单例实现，避免状态重复
- ✅ **UTC+8 时区**：所有时间操作统一使用 UTC+8 时区
- ✅ **数据去重**：移除重复显示的统计数据，优化用户体验

### 🐛 问题修复

- ✅ 修复日志重复输出问题
- ✅ 修复时区不一致问题
- ✅ 修复成就解锁重复提醒
- ✅ 修复成就查询数据错误（PostgreSQL 布尔类型判断）
- ✅ 修复成就显示数据错误（`unlocked === 1` 改为 `unlocked === true`）
- ✅ 修复群组名称显示问题（优先从数据库获取，支持从 Bot 内存获取）
- ✅ 修复排行榜分页问题（支持后续页面查询）
- ✅ 修复成就设置显示时的参数错误（`achievement_id`/`achievement_name` 改为 `id`/`name`）
- ✅ 修复全局统计用户数重复计算问题（`#水群总统计` 中用户数现在使用 Set 去重，确保跨群用户不重复计算）
- ✅ 修复 Guoba-Plugin 集成中群专属成就路径错误（`getConfigData.js` 和 `setConfigData.js` 中路径从 `config/achievements/group` 更新为 `data/achievements/group`）

### 🔧 配置优化

#### 目录结构优化
- ✅ **成就配置目录迁移**：将用户自定义成就配置目录从 `config/achievements` 迁移到 `data/achievements`
  - 系统默认成就仍保留在 `config/achievements.json`（只读）
  - 用户自定义成就现在存放在 `data/achievements/` 目录下
  - 群专属成就现在存放在 `data/achievements/group/{群ID}/` 目录下
  - 更符合数据与配置的分离原则，便于版本控制和数据管理
  - 更新相关代码路径：`AchievementService.js`、`getConfigData.js`、`setConfigData.js`
- ✅ **Git 忽略规则优化**：精确控制 `.gitignore`，确保用户配置不被提交，但保留 README.md 文档

### 📝 文档更新

- ✅ 更新 README.md，添加新功能说明
- ✅ 创建 CHANGELOG.md，详细记录所有更新内容
- ✅ 添加 Gitee 仓库链接
- ✅ 更新成就配置说明文档路径（`data/achievements/README.md`）

---

## [2.x.x] - 历史版本

> 注：v2.x 版本及之前的历史变更记录未详细记录。

---

## 版本说明

- **主版本号（Major）**：不兼容的 API 变更
- **次版本号（Minor）**：向后兼容的功能新增
- **修订版本号（Patch）**：向后兼容的问题修复

---

## 贡献指南

如果你发现文档中缺少某项更新，欢迎提交 Issue 或 Pull Request 来完善本文档。

