<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>æ°´ç¾¤èƒŒæ™¯å›¾ç‰‡ç¼–è¾‘å™¨</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				background: #4A90E2;
				min-height: 100vh;
				color: #333;
			}

			.container {
				max-width: 1400px;
				margin: 0 auto;
				padding: 20px;
			}

			header {
				text-align: center;
				margin-bottom: 30px;
				color: white;
			}

			header h1 {
				font-size: 2.5rem;
				margin-bottom: 10px;
				font-weight: 700;
				text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
			}

			header p {
				font-size: 1.1rem;
				opacity: 0.95;
			}


			/* ä¸»ç¼–è¾‘åŒºåŸŸ */
			.editor-container {
				background: rgba(255, 255, 255, 0.95);
				border-radius: 20px;
				padding: 30px;
				box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.2);
				min-height: 600px;
				display: flex;
				gap: 30px;
			}

			/* å·¦ä¾§é¢æ¿ */
			.left-panel {
				flex: 0 0 350px;
				display: flex;
				flex-direction: column;
				gap: 20px;
			}

			/* å³ä¾§é¢æ¿ */
			.right-panel {
				flex: 1;
				display: flex;
				flex-direction: column;
				gap: 20px;
			}

			/* ä¸Šä¼ åŒºåŸŸ */
			.upload-section {
				text-align: center;
				padding: 20px;
			}

			.upload-area {
				background: rgba(255, 255, 255, 0.1);
				border: 3px dashed #4A90E2;
				border-radius: 15px;
				padding: 40px 20px;
				cursor: pointer;
				transition: all 0.3s ease;
				position: relative;
				backdrop-filter: blur(10px);
				min-height: 200px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.upload-area:hover {
				border-color: #4CAF50;
				background: rgba(255, 255, 255, 0.2);
			}

			.upload-area.dragover {
				border-color: #4CAF50;
				background: rgba(255, 255, 255, 0.3);
			}

			.upload-icon {
				width: 48px;
				height: 48px;
				fill: #4A90E2;
				margin-bottom: 16px;
				opacity: 0.8;
			}

			.upload-content p {
				font-size: 1.1rem;
				margin-bottom: 8px;
				color: #2d3748;
				font-weight: 500;
			}

			.upload-hint {
				font-size: 0.85rem;
				color: #718096;
				font-weight: 400;
			}

			/* ç¼–è¾‘åŒºåŸŸ */
			.edit-section {
				display: flex;
				flex-direction: column;
				gap: 20px;
			}

			.canvas-wrapper {
				position: relative;
				background: #f8f9fa;
				border-radius: 12px;
				overflow: hidden;
				border: 2px solid #4A90E2;
				margin-bottom: 20px;
				min-height: 500px;
				display: flex;
				justify-content: center;
				align-items: center;
				box-shadow: 0 4px 15px rgba(74, 144, 226, 0.15);
			}

			.canvas-wrapper::before {
				content: '';
				position: absolute;
				top: -3px;
				left: -3px;
				right: -3px;
				bottom: -3px;
				background: #4A90E2;
				border-radius: 15px;
				z-index: -1;
				opacity: 0.3;
			}

			#fabricCanvas {
				display: block;
				max-width: 100%;
				max-height: 100%;
				position: relative;
			}

			/* ç›®æ ‡å°ºå¯¸è¾¹æ¡†æŒ‡ç¤º */
			.target-size-indicator {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				border: 2px dashed #4A90E2;
				background: rgba(74, 144, 226, 0.1);
				pointer-events: none;
				z-index: 1;
				transition: all 0.3s ease;
			}

			.target-size-indicator::before {
				content: attr(data-size);
				position: absolute;
				top: -25px;
				left: 50%;
				transform: translateX(-50%);
				background: #4A90E2;
				color: white;
				padding: 4px 8px;
				border-radius: 4px;
				font-size: 12px;
				font-weight: 600;
				white-space: nowrap;
			}


			/* èƒŒæ™¯ç±»å‹é€‰æ‹© */
			.background-type-selector {
				margin-bottom: 20px;
				text-align: center;
			}

			.background-type-selector h3 {
				margin-bottom: 16px;
				color: #2d3748;
				font-size: 1.2rem;
				font-weight: 600;
			}

			.type-options {
				display: flex;
				flex-direction: column;
				gap: 12px;
				align-items: center;
			}

			.type-option {
				width: 100%;
				max-width: 320px;
				cursor: pointer;
			}

			.type-option input[type="radio"] {
				display: none;
			}

			.option-content {
				background: rgba(255, 255, 255, 0.95);
				border: 2px solid transparent;
				border-radius: 12px;
				padding: 20px;
				text-align: center;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
				gap: 12px;
			}

			.type-option input[type="radio"]:checked+.option-content {
				border-color: #4A90E2;
				background: rgba(255, 255, 255, 1);
				box-shadow: 0 4px 15px rgba(74, 144, 226, 0.2);
			}

			.option-icon {
				font-size: 1.8rem;
				flex-shrink: 0;
			}

			.option-text {
				text-align: left;
				flex: 1;
			}

			.option-title {
				font-weight: 600;
				color: #2d3748;
				margin-bottom: 4px;
				font-size: 1rem;
			}

			.option-desc {
				color: #4A90E2;
				font-size: 0.85rem;
				font-weight: 500;
			}

			/* è®¾ç½®æŒ‰é’®æ ·å¼ */
			.settings-option {
				cursor: pointer;
				margin-top: 25px;
				/* å¢åŠ ä¸ä¸Šæ–¹é€‰é¡¹çš„é—´è· */
			}

			.settings-option .option-content {
				background: rgba(255, 255, 255, 0.95);
				border: 2px solid #e9ecef;
				border-radius: 12px;
				padding: 20px;
				text-align: center;
				display: flex;
				align-items: center;
				gap: 12px;
				/* ç§»é™¤æ‰€æœ‰è¿‡æ¸¡æ•ˆæœå’Œæ‚¬æµ®æ•ˆæœ */
			}


			/* æ§åˆ¶é¢æ¿ */
			.controls-panel {
				background: #ffffff;
				border-radius: 12px;
				padding: 20px;
				margin-bottom: 20px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.control-group {
				margin-bottom: 16px;
			}

			.control-group h3 {
				font-size: 1rem;
				margin-bottom: 12px;
				color: #2d3748;
				font-weight: 600;
			}

			.button-group {
				display: flex;
				gap: 10px;
				flex-wrap: wrap;
			}

			.btn {
				padding: 10px 16px;
				border: none;
				border-radius: 8px;
				font-size: 0.9rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				text-align: center;
				position: relative;
				overflow: hidden;
			}

			/* æŒ‰é’®åŸºç¡€æ ·å¼ */
			.btn-primary,
			.modal-btn-primary {
				background: #4A90E2;
				color: white;
				box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
			}

			.btn-primary:hover,
			.modal-btn-primary:hover {
				background: #357ABD;
				box-shadow: 0 6px 20px rgba(74, 144, 226, 0.5);
			}

			.btn-secondary,
			.modal-btn-secondary {
				background: #f8f9fa;
				color: #555;
				border: 2px solid #e9ecef;
			}

			.btn-secondary:hover,
			.modal-btn-secondary:hover {
				background: #e9ecef;
				border-color: #dee2e6;
			}

			/* ç¼©æ”¾æ§åˆ¶æ ·å¼ - é»˜è®¤éšè—ï¼ˆPCç«¯ï¼‰ */
			.zoom-control-group {
				display: none;
			}

			.zoom-controls {
				display: flex;
				flex-direction: column;
				gap: 12px;
			}

			.zoom-display {
				text-align: center;
				padding: 8px 12px;
				background: #f8f9fa;
				border: 2px solid #e9ecef;
				border-radius: 8px;
				font-weight: 600;
				color: #4A90E2;
				font-size: 1rem;
			}

			.zoom-controls .button-group {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 8px;
			}

			.zoom-controls .button-group button:last-child {
				grid-column: 1 / -1;
			}



			/* åŠ è½½åŠ¨ç”» */
			.loading-overlay {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0, 0, 0, 0.7);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 1000;
			}

			.loading-content {
				background: white;
				padding: 40px;
				border-radius: 15px;
				text-align: center;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
			}

			.spinner {
				width: 40px;
				height: 40px;
				border: 4px solid #f3f3f3;
				border-top: 4px solid #4A90E2;
				border-radius: 50%;
				animation: spin 1s linear infinite;
				margin: 0 auto 20px;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}

				100% {
					transform: rotate(360deg);
				}
			}

			/* Toast æç¤º */
			.toast {
				position: fixed;
				top: 20px;
				right: 20px;
				background: rgba(0, 0, 0, 0.9);
				color: white;
				padding: 15px 20px;
				border-radius: 10px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
				z-index: 99999;
				transform: translateX(400px);
				transition: transform 0.3s ease;
				backdrop-filter: blur(10px);
			}

			.toast.show {
				transform: translateX(0);
			}

			.toast-content {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.toast-icon {
				font-size: 1.2rem;
			}

			.toast-message {
				font-size: 0.95rem;
				font-weight: 500;
			}

			/* å“åº”å¼è®¾è®¡ */
			@media (max-width: 1024px) {
				.container {
					padding: 15px;
				}

				.editor-container {
					padding: 20px;
					flex-direction: column;
				}

				.left-panel {
					flex: none;
					width: 100%;
				}

				.right-panel {
					flex: none;
					width: 100%;
				}

				.canvas-wrapper {
					min-height: 450px;
				}
			}

			@media (max-width: 768px) {
				.container {
					padding: 10px;
				}

				header h1 {
					font-size: 1.8rem;
				}

				header p {
					font-size: 1rem;
				}

				.editor-container {
					padding: 15px;
					min-height: auto;
				}

				.canvas-wrapper {
					min-height: 300px;
					margin-bottom: 15px;
				}

				#fabricCanvas {
					max-height: 300px;
				}

				.type-options {
					flex-direction: column;
					gap: 10px;
				}

				.type-option {
					max-width: none;
				}

				.option-content {
					padding: 15px;
					gap: 10px;
				}

				.option-icon {
					font-size: 1.5rem;
				}

				.option-title {
					font-size: 1rem;
				}

				.option-desc {
					font-size: 0.8rem;
				}

				.controls-panel {
					padding: 15px;
				}

				.button-group {
					flex-direction: column;
					gap: 8px;
				}

				.btn {
					width: 100%;
					padding: 10px 15px;
					font-size: 0.9rem;
				}

				/* ç§»åŠ¨ç«¯æ˜¾ç¤ºç¼©æ”¾æ§åˆ¶ç»„ */
				.zoom-control-group {
					display: block;
				}

			}

			@media (max-width: 480px) {
				.container {
					padding: 8px;
				}

				header h1 {
					font-size: 1.5rem;
				}

				.editor-container {
					padding: 10px;
					border-radius: 15px;
				}

				.canvas-wrapper {
					min-height: 250px;
					border-radius: 10px;
				}

				#fabricCanvas {
					max-height: 250px;
				}

				.type-options {
					gap: 8px;
				}

				.option-content {
					padding: 12px;
					gap: 8px;
				}

				.option-icon {
					font-size: 1.2rem;
				}

				.option-title {
					font-size: 0.9rem;
				}

				.option-desc {
					font-size: 0.75rem;
				}

				.controls-panel {
					padding: 10px;
				}

				.btn {
					padding: 8px 12px;
					font-size: 0.85rem;
				}

			}

			/* éšè—æ–‡ä»¶è¾“å…¥ */
			#fileInput {
				display: none;
			}

			/* è‡ªå®šä¹‰å¼¹çª—æ ·å¼ */
			.modal-overlay {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0, 0, 0, 0.7);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 10000;
				backdrop-filter: blur(5px);
				opacity: 0;
				transition: opacity 0.3s ease;
			}

			.modal-overlay.show {
				opacity: 1;
			}

			.modal-container {
				background: #ffffff;
				border-radius: 20px;
				box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
				max-width: 500px;
				width: 90%;
				max-height: 80vh;
				overflow: hidden;
				transform: scale(0.8) translateY(20px);
				transition: transform 0.3s ease;
			}

			.modal-overlay.show .modal-container {
				transform: scale(1) translateY(0);
			}

			.modal-header {
				background: #4A90E2;
				color: white;
				padding: 20px 25px;
				display: flex;
				align-items: center;
				justify-content: space-between;
				position: relative;
			}

			.modal-header::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(255, 255, 255, 0.1);
				pointer-events: none;
			}

			.modal-title {
				margin: 0;
				font-size: 1.3rem;
				font-weight: 700;
				text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
			}

			.modal-close {
				background: none;
				border: none;
				color: white;
				font-size: 1.8rem;
				cursor: pointer;
				padding: 0;
				width: 30px;
				height: 30px;
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 50%;
				transition: all 0.3s ease;
				position: relative;
				z-index: 1;
			}

			.modal-close:hover {
				background: rgba(255, 255, 255, 0.2);
				transform: scale(1.1);
			}

			.modal-body {
				padding: 25px;
			}

			.modal-message {
				margin: 0 0 20px 0;
				color: #2d3748;
				font-size: 1rem;
				line-height: 1.6;
				text-align: center;
			}

			.modal-input-group {
				margin-top: 20px;
			}

			.modal-input {
				width: 100%;
				padding: 15px 20px;
				border: 2px solid #e9ecef;
				border-radius: 12px;
				font-size: 1rem;
				transition: all 0.3s ease;
				background: #f8f9fa;
				box-sizing: border-box;
			}

			.modal-input:focus {
				outline: none;
				border-color: #4A90E2;
				background: white;
				box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
			}

			.modal-footer {
				padding: 20px 25px;
				background: #f8f9fa;
				display: flex;
				gap: 12px;
				justify-content: flex-end;
			}

			/* è®¾ç½®å¼¹çª—åŠ¨ä½œæŒ‰é’®ç¾åŒ– */
			.modal-actions {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 14px;
				margin-top: 6px;
			}

			.action-card {
				display: flex;
				align-items: center;
				gap: 12px;
				border: 2px solid #e9ecef;
				background: #fff;
				border-radius: 12px;
				padding: 14px 16px;
				cursor: pointer;
				transition: box-shadow .2s ease, border-color .2s ease, transform .05s ease;
				user-select: none;
			}

			.action-card:hover {
				border-color: #4A90E2;
				box-shadow: 0 4px 14px rgba(74, 144, 226, .18);
			}

			.action-card:active {
				transform: translateY(1px);
			}

			.action-icon {
				font-size: 1.4rem;
				width: 28px;
				text-align: center;
			}

			.action-text {
				display: flex;
				flex-direction: column;
				text-align: left;
			}

			.action-title {
				font-weight: 700;
				color: #2d3748;
				line-height: 1.2;
			}

			.action-desc {
				font-size: .85rem;
				color: #718096;
				margin-top: 2px;
			}

			.modal-btn {
				padding: 12px 24px;
				border: none;
				border-radius: 10px;
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				min-width: 80px;
			}


			/* é‡ç½®ç§˜é’¥å¼¹çª—æ ·å¼ */
			.reset-key-form {
				margin-top: 20px;
			}

			.input-group {
				margin-bottom: 20px;
			}

			.input-label {
				display: block;
				font-weight: 600;
				color: #2d3748;
				margin-bottom: 8px;
				font-size: 0.9rem;
			}

			.verification-group {
				display: flex;
				gap: 10px;
				align-items: center;
			}

			.verification-input {
				flex: 1;
			}

			.send-code-btn {
				padding: 15px 16px;
				background: #4A90E2;
				color: white;
				border: none;
				border-radius: 8px;
				font-size: 0.85rem;
				font-weight: 600;
				cursor: pointer;
				transition: background-color 0.3s ease;
				white-space: nowrap;
				min-width: 100px;
				height: 48px;
				box-sizing: border-box;
			}

			.send-code-btn:hover:not(:disabled) {
				background: #357ABD;
			}

			.send-code-btn:disabled {
				background: #a0aec0;
				cursor: not-allowed;
				transform: none;
				box-shadow: none;
			}

			.verification-hint {
				font-size: 0.75rem;
				color: #718096;
				margin-top: 6px;
				text-align: center;
			}

			/* å¼¹çª—å“åº”å¼è®¾è®¡ */
			@media (max-width: 768px) {
				.modal-container {
					width: 95%;
					margin: 20px;
				}

				.modal-header {
					padding: 15px 20px;
				}

				.modal-title {
					font-size: 1.1rem;
				}

				.modal-body {
					padding: 20px;
				}

				.modal-footer {
					padding: 15px 20px;
					flex-direction: column;
				}

				.modal-btn {
					width: 100%;
					margin: 0;
				}

				.verification-group {
					flex-direction: column;
					gap: 8px;
				}

				.send-code-btn {
					width: 100%;
					min-width: auto;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header>
				<h1>ğŸ¨ å°ç±³ç³• - èƒŒæ™¯ç¼–è¾‘å™¨</h1>
			</header>


			<div class="editor-container">
				<!-- å·¦ä¾§é¢æ¿ -->
				<div class="left-panel">
					<!-- ä¸Šä¼ åŒºåŸŸ -->
					<div class="upload-section" id="uploadSection">
						<div class="upload-area" id="uploadArea">
							<div class="upload-content">
								<svg class="upload-icon" viewBox="0 0 24 24">
									<path
										d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z" />
								</svg>
								<p>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
								<p class="upload-hint">âœ¨ æ”¯æŒä»»æ„å¤§å°å’Œæ ¼å¼çš„å›¾ç‰‡</p>
							</div>
							<input type="file" id="fileInput" accept="image/*">
						</div>
					</div>

					<!-- èƒŒæ™¯ç±»å‹é€‰æ‹© -->
					<div class="background-type-selector">
						<h3>ğŸ¯ é€‰æ‹©èƒŒæ™¯ç±»å‹</h3>
						<div class="type-options">
							<label class="type-option">
								<input type="radio" name="backgroundType" value="ranking" checked>
								<div class="option-content">
									<div class="option-icon">ğŸ†</div>
									<div class="option-text">
										<div class="option-title">æ’è¡Œæ¦œèƒŒæ™¯</div>
										<div class="option-desc">æ’è¡Œæ¦œå¡ç‰‡ä¸“ç”¨ | #æ°´ç¾¤æ¦œ</div>
									</div>
								</div>
							</label>

							<label class="type-option">
								<input type="radio" name="backgroundType" value="normal">
								<div class="option-content">
									<div class="option-icon">ğŸ“Š</div>
									<div class="option-text">
										<div class="option-title">æ™®é€šèƒŒæ™¯</div>
										<div class="option-desc">ä¸ªäººç»Ÿè®¡é¡µé¢ | #æ°´ç¾¤æŸ¥è¯¢</div>
									</div>
								</div>
							</label>

							<!-- è®¾ç½®æŒ‰é’®ï¼ˆå¼¹çª—ä¸­æä¾›å­æ“ä½œï¼‰ -->
							<div class="type-option settings-option">
								<div class="option-content" id="settingsBtn">
									<div class="option-icon">âš™ï¸</div>
									<div class="option-text">
										<div class="option-title">è®¾ç½®</div>
										<div class="option-desc">é‡ç½®ç§˜é’¥</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- å³ä¾§é¢æ¿ -->
				<div class="right-panel">
					<!-- ç¼–è¾‘åŒºåŸŸ -->
					<div class="edit-section" id="editSection">
						<!-- ç”»å¸ƒåŒºåŸŸ -->
						<div class="canvas-wrapper">
							<canvas id="fabricCanvas"></canvas>
						</div>

						<!-- æ§åˆ¶é¢æ¿ -->
						<div class="controls-panel">
							<div class="control-group">
								<h3>âš¡ æ“ä½œ</h3>
								<div class="button-group">
									<button id="resetBtn" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
									<button id="rotateBtn" class="btn btn-secondary">â†©ï¸ æ—‹è½¬90Â°</button>
									<button id="confirmBtn" class="btn btn-primary">ğŸ’¾ ç¡®è®¤è®¾ç½®</button>
								</div>
							</div>

							<div class="control-group zoom-control-group">
								<h3>ğŸ” ç¼©æ”¾æ§åˆ¶</h3>
								<div class="zoom-controls">
									<div class="zoom-display">
										<span id="zoomLevel">100%</span>
									</div>
									<div class="button-group">
										<button id="zoomOutBtn" class="btn btn-secondary">â– ç¼©å°</button>
										<button id="zoomInBtn" class="btn btn-secondary">â• æ”¾å¤§</button>
										<button id="zoomResetBtn" class="btn btn-secondary">ğŸ¯ é‡ç½®ç¼©æ”¾</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>

			<!-- åŠ è½½åŠ¨ç”» -->
			<div class="loading-overlay" id="loadingOverlay" style="display: none;">
				<div class="loading-content">
					<div class="spinner"></div>
					<p>ğŸ”„ æ­£åœ¨å¤„ç†å›¾ç‰‡...</p>
				</div>
			</div>

			<!-- Toast æç¤º -->
			<div class="toast" id="toast">
				<div class="toast-content">
					<span class="toast-icon">â„¹ï¸</span>
					<span class="toast-message">æç¤ºä¿¡æ¯</span>
				</div>
			</div>

			<!-- è‡ªå®šä¹‰å¼¹çª— -->
			<div class="modal-overlay" id="modalOverlay" style="display: none;">
				<div class="modal-container">
					<div class="modal-header">
						<h3 class="modal-title" id="modalTitle">æ ‡é¢˜</h3>
						<button class="modal-close" id="modalClose">Ã—</button>
					</div>
					<div class="modal-body">
						<p class="modal-message" id="modalMessage">æ¶ˆæ¯å†…å®¹</p>
						<div class="modal-input-group" id="modalInputGroup" style="display: none;">
							<input type="text" class="modal-input" id="modalInput" placeholder="è¯·è¾“å…¥å†…å®¹">
						</div>
					</div>
					<div class="modal-footer">
						<button class="modal-btn modal-btn-secondary" id="modalCancel">å–æ¶ˆ</button>
						<button class="modal-btn modal-btn-primary" id="modalConfirm">ç¡®å®š</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			class ImageEditorV2 {
				constructor() {
					this.canvas = null;
					this.currentStep = 1;
					this.targetWidth = 760;
					this.targetHeight = 360;
					this.originalImage = null;
					this.currentImage = null;

					this.initElements();
					this.initEventListeners();
					this.initCanvas();
				}

				initElements() {
					this.elements = {
						uploadArea: document.getElementById('uploadArea'),
						fileInput: document.getElementById('fileInput'),
						uploadSection: document.getElementById('uploadSection'),
						editSection: document.getElementById('editSection'),
						fabricCanvas: document.getElementById('fabricCanvas'),
						resetBtn: document.getElementById('resetBtn'),
						rotateBtn: document.getElementById('rotateBtn'),
						confirmBtn: document.getElementById('confirmBtn'),
						// ç¼©æ”¾æ§åˆ¶å…ƒç´ 
						zoomLevel: document.getElementById('zoomLevel'),
						zoomOutBtn: document.getElementById('zoomOutBtn'),
						zoomInBtn: document.getElementById('zoomInBtn'),
						zoomResetBtn: document.getElementById('zoomResetBtn'),
						loadingOverlay: document.getElementById('loadingOverlay'),
						toast: document.getElementById('toast'),
						// å¼¹çª—ç›¸å…³å…ƒç´ 
						modalOverlay: document.getElementById('modalOverlay'),
						modalTitle: document.getElementById('modalTitle'),
						modalMessage: document.getElementById('modalMessage'),
						modalInputGroup: document.getElementById('modalInputGroup'),
						modalInput: document.getElementById('modalInput'),
						modalClose: document.getElementById('modalClose'),
						modalCancel: document.getElementById('modalCancel'),
						modalConfirm: document.getElementById('modalConfirm'),
						// è®¾ç½®æŒ‰é’®
						settingsBtn: document.getElementById('settingsBtn'),
					};
				}

				initEventListeners() {
					// æ–‡ä»¶ä¸Šä¼ 
					this.elements.uploadArea.addEventListener('click', () => {
						this.elements.fileInput.click();
					});

					this.elements.uploadArea.addEventListener('dragover', (e) => {
						e.preventDefault();
						this.elements.uploadArea.classList.add('dragover');
					});

					this.elements.uploadArea.addEventListener('dragleave', () => {
						this.elements.uploadArea.classList.remove('dragover');
					});

					this.elements.uploadArea.addEventListener('drop', (e) => {
						e.preventDefault();
						this.elements.uploadArea.classList.remove('dragover');
						const files = e.dataTransfer.files;
						if (files.length > 0) {
							this.loadImage(files[0]);
						}
					});

					this.elements.fileInput.addEventListener('change', (e) => {
						if (e.target.files.length > 0) {
							this.loadImage(e.target.files[0]);
						}
					});

					// èƒŒæ™¯ç±»å‹é€‰æ‹©
					const backgroundTypeInputs = document.querySelectorAll('input[name="backgroundType"]');
					backgroundTypeInputs.forEach(input => {
						input.addEventListener('change', () => {
							this.updateTargetSize();
							this.updateCanvasSize();

							// æ˜¾ç¤ºåˆ‡æ¢æç¤º
							const selectedType = input.value;
							const typeName = selectedType === 'ranking' ? 'æ’è¡Œæ¦œèƒŒæ™¯' : 'æ™®é€šèƒŒæ™¯';
							this.showToast(`å·²åˆ‡æ¢åˆ°${typeName} (${this.targetWidth}Ã—${this.targetHeight})`,
								'info');
						});
					});

					// æ§åˆ¶æŒ‰é’®
					this.elements.resetBtn.addEventListener('click', () => this.resetImage());
					this.elements.rotateBtn.addEventListener('click', () => this.rotateImage());
					this.elements.confirmBtn.addEventListener('click', () => this.confirmBackground());

					// ç¼©æ”¾æ§åˆ¶æŒ‰é’®
					this.elements.zoomOutBtn.addEventListener('click', () => this.zoomOut());
					this.elements.zoomInBtn.addEventListener('click', () => this.zoomIn());
					this.elements.zoomResetBtn.addEventListener('click', () => this.zoomReset());

					// å¼¹çª—äº‹ä»¶ç›‘å¬å™¨
					this.elements.modalClose.addEventListener('click', () => this.hideModal());
					this.elements.modalCancel.addEventListener('click', () => this.hideModal());
					this.elements.modalOverlay.addEventListener('click', (e) => {
						if (e.target === this.elements.modalOverlay) {
							this.hideModal();
						}
					});

					// å›è½¦é”®ç¡®è®¤
					this.elements.modalInput.addEventListener('keypress', (e) => {
						if (e.key === 'Enter') {
							this.elements.modalConfirm.click();
						}
					});

					this.elements.settingsBtn.addEventListener('click', () => this.showResetKeyModal());
				}

				initCanvas() {
					this.canvas = new fabric.Canvas('fabricCanvas', {
						width: 800,
						height: 500,
						backgroundColor: '#f8f9fa',
						selection: true,
						preserveObjectStacking: true,
						allowTouchScrolling: true
					});

					// å¯ç”¨é¼ æ ‡æ»šè½®ç¼©æ”¾
					this.canvas.on('mouse:wheel', (opt) => {
						const delta = opt.e.deltaY;
						let zoom = this.canvas.getZoom();
						zoom *= 0.999 ** delta;
						if (zoom > 20) zoom = 20;
						if (zoom < 0.01) zoom = 0.01;
						this.canvas.zoomToPoint({
							x: opt.e.offsetX,
							y: opt.e.offsetY
						}, zoom);
						opt.e.preventDefault();
						opt.e.stopPropagation();
					});

					// åˆå§‹åŒ–å°ºå¯¸ï¼ˆæ ¹æ®é»˜è®¤é€‰ä¸­çš„èƒŒæ™¯ç±»å‹ï¼‰
					this.updateTargetSize();
					// åˆå§‹åŒ–ç¼©æ”¾æ˜¾ç¤º
					this.updateZoomDisplay();

					// è®¾ç½®ç”»å¸ƒå°ºå¯¸
					this.updateCanvasSize();

					// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç§˜é’¥
					this.checkSecretKeyOnLoad();

					// ç›‘å¬çª—å£å¤§å°å˜åŒ–
					window.addEventListener('resize', () => {
						this.updateCanvasSize();
					});
				}

				updateTargetSize() {
					const selectedType = document.querySelector('input[name="backgroundType"]:checked').value;
					if (selectedType === 'ranking') {
						this.targetWidth = 1520;
						this.targetHeight = 200;
					} else {
						this.targetWidth = 760;
						this.targetHeight = 360;
					}
				}

				updateCanvasSize() {
					const aspectRatio = this.targetWidth / this.targetHeight;
					const isMobile = window.innerWidth <= 768;
					const isSmallMobile = window.innerWidth <= 480;

					// æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®æœ€å¤§å°ºå¯¸
					let maxWidth, maxHeight;
					if (isSmallMobile) {
						maxWidth = Math.min(350, window.innerWidth - 30);
						maxHeight = 300;
					} else if (isMobile) {
						maxWidth = Math.min(500, window.innerWidth - 30);
						maxHeight = 400;
					} else {
						maxWidth = 800;
						maxHeight = 500;
					}

					let canvasWidth = maxWidth;
					let canvasHeight = maxWidth / aspectRatio;

					if (canvasHeight > maxHeight) {
						canvasHeight = maxHeight;
						canvasWidth = maxHeight * aspectRatio;
					}

					// ç¡®ä¿ç”»å¸ƒå°ºå¯¸æ˜¯æ•´æ•°
					canvasWidth = Math.floor(canvasWidth);
					canvasHeight = Math.floor(canvasHeight);

					this.canvas.setDimensions({
						width: canvasWidth,
						height: canvasHeight
					});

					// æ›´æ–°å°ºå¯¸æŒ‡ç¤ºå™¨
					this.updateSizeIndicator();

					// æ›´æ–°ç›®æ ‡å°ºå¯¸è¾¹æ¡†æŒ‡ç¤º
					this.updateTargetSizeIndicator(canvasWidth, canvasHeight);

					// å¦‚æœæœ‰å›¾ç‰‡ï¼Œåªè°ƒæ•´ç”»å¸ƒå°ºå¯¸ï¼Œä¸é‡æ–°å±…ä¸­å›¾ç‰‡
					if (this.currentImage) {
						// ä¿æŒå›¾ç‰‡å½“å‰ä½ç½®å’Œç¼©æ”¾ï¼Œåªæ›´æ–°ç”»å¸ƒå°ºå¯¸
						this.canvas.renderAll();
					}
				}

				updateSizeIndicator() {
					// æ·»åŠ æˆ–æ›´æ–°å°ºå¯¸æŒ‡ç¤ºå™¨
					let indicator = document.getElementById('sizeIndicator');
					if (!indicator) {
						indicator = document.createElement('div');
						indicator.id = 'sizeIndicator';
						indicator.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: rgba(0, 0, 0, 0.7);
                        color: white;
                        padding: 8px 12px;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: 600;
                        z-index: 1000;
                    `;
						document.querySelector('.canvas-wrapper').appendChild(indicator);
					}

					const selectedType = document.querySelector('input[name="backgroundType"]:checked').value;
					const typeName = selectedType === 'ranking' ? 'æ’è¡Œæ¦œèƒŒæ™¯' : 'æ™®é€šèƒŒæ™¯';
					indicator.textContent = `${typeName}: ${this.targetWidth}Ã—${this.targetHeight}`;
				}

				updateTargetSizeIndicator(canvasWidth, canvasHeight) {
					// æ·»åŠ æˆ–æ›´æ–°ç›®æ ‡å°ºå¯¸è¾¹æ¡†æŒ‡ç¤º
					let targetIndicator = document.getElementById('targetSizeIndicator');
					if (!targetIndicator) {
						targetIndicator = document.createElement('div');
						targetIndicator.id = 'targetSizeIndicator';
						targetIndicator.className = 'target-size-indicator';
						document.querySelector('.canvas-wrapper').appendChild(targetIndicator);
					}

					// è®¡ç®—ç›®æ ‡å°ºå¯¸åœ¨ç”»å¸ƒä¸­çš„æ˜¾ç¤ºå°ºå¯¸
					// ç¡®ä¿æŒ‡ç¤ºå™¨å°ºå¯¸ä¸ç”»å¸ƒå°ºå¯¸ä¿æŒç›¸åŒçš„æ¯”ä¾‹å…³ç³»
					const targetAspectRatio = this.targetWidth / this.targetHeight;
					const canvasAspectRatio = canvasWidth / canvasHeight;

					let indicatorWidth, indicatorHeight;

					// ä½¿ç”¨ä¸ç”»å¸ƒç›¸åŒçš„ç¼©æ”¾é€»è¾‘
					if (targetAspectRatio > canvasAspectRatio) {
						// ç›®æ ‡å°ºå¯¸æ›´å®½ï¼Œä»¥å®½åº¦ä¸ºå‡†
						indicatorWidth = canvasWidth;
						indicatorHeight = canvasWidth / targetAspectRatio;
					} else {
						// ç›®æ ‡å°ºå¯¸æ›´é«˜ï¼Œä»¥é«˜åº¦ä¸ºå‡†
						indicatorHeight = canvasHeight;
						indicatorWidth = canvasHeight * targetAspectRatio;
					}

					// è®¾ç½®æŒ‡ç¤ºå™¨å°ºå¯¸å’Œä½ç½®
					targetIndicator.style.width = `${indicatorWidth}px`;
					targetIndicator.style.height = `${indicatorHeight}px`;
					targetIndicator.setAttribute('data-size', `${this.targetWidth}Ã—${this.targetHeight}`);
				}




				loadImage(file) {
					const reader = new FileReader();
					reader.onload = (e) => {
						fabric.Image.fromURL(e.target.result, (img) => {
							this.originalImage = img;
							this.currentImage = img;

							// æ¸…é™¤ç”»å¸ƒ
							this.canvas.clear();

							// æ·»åŠ å›¾ç‰‡åˆ°ç”»å¸ƒ
							this.canvas.add(img);

							// è°ƒæ•´å›¾ç‰‡å¤§å°ä»¥é€‚åº”ç”»å¸ƒ
							this.fitImageToCanvas();

							// æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
							this.showEditMode();
							this.updateZoomDisplay();
							this.showToast('å›¾ç‰‡åŠ è½½æˆåŠŸï¼', 'success');
						});
					};
					reader.readAsDataURL(file);
				}

				fitImageToCanvas(showToast = true) {
					if (!this.currentImage) return;

					const canvasWidth = this.canvas.getWidth();
					const canvasHeight = this.canvas.getHeight();
					const imageWidth = this.currentImage.width;
					const imageHeight = this.currentImage.height;

					// è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œç¡®ä¿å›¾ç‰‡å®Œå…¨è¦†ç›–ç”»å¸ƒ
					const scaleX = canvasWidth / imageWidth;
					const scaleY = canvasHeight / imageHeight;
					const scale = Math.max(scaleX, scaleY) * 1.1; // ç¨å¾®æ”¾å¤§ä»¥ç¡®ä¿è¦†ç›–

					// è®¾ç½®å›¾ç‰‡å±æ€§
					this.currentImage.set({
						scaleX: scale,
						scaleY: scale,
						left: canvasWidth / 2,
						top: canvasHeight / 2,
						originX: 'center',
						originY: 'center',
						selectable: true,
						evented: true
					});

					// ç¡®ä¿å›¾ç‰‡åœ¨ç”»å¸ƒä¸­å¿ƒ
					this.canvas.centerObject(this.currentImage);
					this.canvas.renderAll();

					// åªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºæç¤º
					if (showToast) {
						this.showToast(`å›¾ç‰‡å·²è°ƒæ•´åˆ° ${this.targetWidth}Ã—${this.targetHeight} æ¯”ä¾‹`, 'info');
					}
				}

				resetImage() {
					if (this.currentImage) {
						this.fitImageToCanvas();
						this.showToast('å›¾ç‰‡å·²é‡ç½®', 'info');
					}
				}

				rotateImage() {
					if (this.currentImage) {
						this.currentImage.rotate((this.currentImage.angle + 90) % 360);
						this.canvas.renderAll();
						this.showToast('å›¾ç‰‡å·²æ—‹è½¬90Â°', 'info');
					}
				}

				zoomIn() {
					const currentZoom = this.canvas.getZoom();
					const newZoom = Math.min(currentZoom * 1.2, 5);
					this.canvas.zoomToPoint({
						x: this.canvas.getWidth() / 2,
						y: this.canvas.getHeight() / 2
					}, newZoom);
					this.updateZoomDisplay();
					this.showToast(`æ”¾å¤§åˆ° ${Math.round(newZoom * 100)}%`, 'info');
				}

				zoomOut() {
					const currentZoom = this.canvas.getZoom();
					const newZoom = Math.max(currentZoom / 1.2, 0.1);
					this.canvas.zoomToPoint({
						x: this.canvas.getWidth() / 2,
						y: this.canvas.getHeight() / 2
					}, newZoom);
					this.updateZoomDisplay();
					this.showToast(`ç¼©å°åˆ° ${Math.round(newZoom * 100)}%`, 'info');
				}

				zoomReset() {
					this.canvas.zoomToPoint({
						x: this.canvas.getWidth() / 2,
						y: this.canvas.getHeight() / 2
					}, 1);
					this.updateZoomDisplay();
					this.showToast('ç¼©æ”¾å·²é‡ç½®', 'info');
				}

				updateZoomDisplay() {
					const zoom = this.canvas.getZoom();
					this.elements.zoomLevel.textContent = `${Math.round(zoom * 100)}%`;
				}


				async confirmBackground() {
					// å…ˆæ˜¾ç¤ºç§˜é’¥éªŒè¯å¼¹çª—
					this.showModal({
						title: 'ğŸ” ç§˜é’¥éªŒè¯',
						message: 'ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œè¯·è¾“å…¥æ‚¨çš„ç§˜é’¥ä»¥ç¡®è®¤è®¾ç½®èƒŒæ™¯',
						showInput: true,
						inputPlaceholder: 'è¯·è¾“å…¥ç§˜é’¥',
						onConfirm: async (inputSecretKey) => {
							if (!inputSecretKey || inputSecretKey.trim() === '') {
								this.showToast('è¯·è¾“å…¥ç§˜é’¥', 'error');
								return false; // é˜»æ­¢å¼¹çª—å…³é—­
							}

							// éªŒè¯ç§˜é’¥
							const isValid = await this.validateInputSecretKey(inputSecretKey.trim());
							if (!isValid) {
								this.showToast('ç§˜é’¥éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥', 'error');
								return false; // é˜»æ­¢å¼¹çª—å…³é—­
							}

							// éªŒè¯é€šè¿‡ï¼Œç»§ç»­è®¾ç½®èƒŒæ™¯
							await this.processBackgroundSetting();
							return true; // å…è®¸å¼¹çª—å…³é—­
						},
						onCancel: () => {
							this.showToast('å·²å–æ¶ˆè®¾ç½®', 'info');
						}
					});
				}

				async processBackgroundSetting() {
					this.elements.loadingOverlay.style.display = 'flex';

					try {
						// ä½¿ç”¨Fabric.jsçš„toDataURLæ–¹æ³•ç”Ÿæˆæœ€ç»ˆå›¾ç‰‡
						const dataURL = this.canvas.toDataURL({
							format: 'jpeg',
							quality: 0.9,
							multiplier: 1
						});

						// åˆ›å»ºç›®æ ‡å°ºå¯¸çš„canvasè¿›è¡Œæœ€ç»ˆè£å‰ª
						const finalCanvas = document.createElement('canvas');
						finalCanvas.width = this.targetWidth;
						finalCanvas.height = this.targetHeight;
						const finalCtx = finalCanvas.getContext('2d');

						// åˆ›å»ºä¸´æ—¶å›¾ç‰‡å¯¹è±¡
						const tempImg = new Image();
						tempImg.onload = () => {
							// è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œç¡®ä¿å›¾ç‰‡å®Œå…¨è¦†ç›–ç›®æ ‡åŒºåŸŸ
							const scaleX = this.targetWidth / tempImg.width;
							const scaleY = this.targetHeight / tempImg.height;
							const scale = Math.max(scaleX, scaleY);

							// è®¡ç®—å±…ä¸­ä½ç½®
							const scaledWidth = tempImg.width * scale;
							const scaledHeight = tempImg.height * scale;
							const offsetX = (this.targetWidth - scaledWidth) / 2;
							const offsetY = (this.targetHeight - scaledHeight) / 2;

							// ç»˜åˆ¶èƒŒæ™¯è‰²
							finalCtx.fillStyle = '#f8f9fa';
							finalCtx.fillRect(0, 0, this.targetWidth, this.targetHeight);

							// ç»˜åˆ¶å›¾ç‰‡
							finalCtx.drawImage(
								tempImg,
								offsetX,
								offsetY,
								scaledWidth,
								scaledHeight
							);

							// è½¬æ¢ä¸ºblobå¹¶ä¸Šä¼ 
							finalCanvas.toBlob(async (blob) => {
								await this.uploadImage(blob);
							}, 'image/jpeg', 0.9);
						};
						tempImg.src = dataURL;

					} catch (error) {
						this.showToast('å¤„ç†å¤±è´¥ï¼š' + error.message, 'error');
					} finally {
						this.elements.loadingOverlay.style.display = 'none';
					}
				}

				async uploadImage(blob) {
					const formData = new FormData();
					formData.append('background', blob, 'background.jpg'); // å­—æ®µåå¿…é¡»ä¸åç«¯multeré…ç½®ä¸€è‡´
					formData.append('userId', this.getUserIdFromUrl());
					formData.append('secretKey', await this.getSecretKey());
					formData.append('backgroundType', this.getBackgroundType());

					try {
						const response = await fetch('/api/apply-background', {
							method: 'POST',
							body: formData
						});

						if (response.ok) {
							this.showToast('èƒŒæ™¯è®¾ç½®æˆåŠŸï¼', 'success');
							setTimeout(() => {
								window.close();
							}, 2000);
						} else {
							const errorData = await response.json().catch(() => ({}));
							throw new Error(errorData.error || 'ä¸Šä¼ å¤±è´¥');
						}
					} catch (error) {
						this.showToast('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
					}
				}

				showEditMode() {
					this.elements.editSection.classList.add('active');
				}

				showToast(message, type = 'info') {
					const iconMap = {
						'info': 'â„¹ï¸',
						'success': 'âœ…',
						'error': 'âŒ',
						'warning': 'âš ï¸'
					};

					const icon = iconMap[type] || 'â„¹ï¸';
					this.elements.toast.querySelector('.toast-icon').textContent = icon;
					this.elements.toast.querySelector('.toast-message').textContent = message;

					this.elements.toast.classList.add('show');

					setTimeout(() => {
						this.elements.toast.classList.remove('show');
					}, 3000);
				}

				getUserIdFromUrl() {
					const urlParams = new URLSearchParams(window.location.search);
					const userId = urlParams.get('userId');
					if (!userId) {
						throw new Error('ç¼ºå°‘ç”¨æˆ·IDå‚æ•°');
					}
					return userId;
				}

				async checkSecretKeyOnLoad() {
					try {
						const userId = this.getUserIdFromUrl();
						// ä»…æ£€æŸ¥æœåŠ¡å™¨ key.json æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·ç§˜é’¥
						const response = await fetch(`/api/secret-key/${userId}`);
						if (response.ok) {
							// æœåŠ¡ç«¯å·²æœ‰ç§˜é’¥ï¼Œä¸å¼¹çª—
							return;
						}
						// æœåŠ¡ç«¯æ²¡æœ‰ç§˜é’¥ï¼Œæç¤ºè®¾ç½®
						this.showSecretKeySetupModal();
					} catch (error) {
						console.error('æ£€æŸ¥ç§˜é’¥å¤±è´¥:', error);
						// å¼‚å¸¸æƒ…å†µä¸‹ä¸å¼ºåˆ¶å¼¹çª—ï¼Œé¿å…æ‰“æ–­ä½¿ç”¨ï¼›ä»…åœ¨ç¡®è®¤ä¸ºæ— ç§˜é’¥æ—¶å¼¹çª—
					}
				}

				async generateSecretKeyFile() {
					try {
						// ç”Ÿæˆéšæœºç§˜é’¥
						const secretKey = this.generateRandomKey();
						const userId = this.getUserIdFromUrl();

						// è°ƒç”¨æœåŠ¡å™¨APIä¿å­˜ç§˜é’¥åˆ°key.json
						const response = await fetch('/api/save-secret-key', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								userId: userId,
								secretKey: secretKey
							})
						});

						if (response.ok) {
							// å­˜å‚¨åˆ°localStorageä»¥ä¾¿åç»­ä½¿ç”¨
							localStorage.setItem('speech_stats_secret_key', secretKey);
							this.showToast('ç§˜é’¥å·²ç”Ÿæˆå¹¶ä¿å­˜åˆ°æœåŠ¡å™¨ï¼', 'success');
						} else {
							const errorData = await response.json();
							throw new Error(errorData.error || 'ä¿å­˜ç§˜é’¥å¤±è´¥');
						}
					} catch (error) {
						console.error('ç”Ÿæˆç§˜é’¥å¤±è´¥:', error);
						this.showToast('ç”Ÿæˆç§˜é’¥å¤±è´¥ï¼š' + error.message, 'error');
					}
				}

				async validateSecretKey(secretKey) {
					try {
						const userId = this.getUserIdFromUrl();
						const response = await fetch(`/api/secret-key/${userId}`);

						if (response.ok) {
							// ç§˜é’¥å­˜åœ¨ä¸”æœ‰æ•ˆ
							this.showToast('ç§˜é’¥éªŒè¯æˆåŠŸï¼', 'success');
							return true;
						} else {
							// ç§˜é’¥æ— æ•ˆï¼Œæç¤ºç”¨æˆ·è®¾ç½®
							this.showSecretKeySetupModal();
							return false;
						}
					} catch (error) {
						console.error('éªŒè¯ç§˜é’¥å¤±è´¥:', error);
						// éªŒè¯å¤±è´¥ï¼Œæç¤ºç”¨æˆ·è®¾ç½®
						this.showSecretKeySetupModal();
						return false;
					}
				}

				showSecretKeySetupModal() {
					this.showModal({
						title: 'ğŸ” è®¾ç½®ç§˜é’¥',
						message: 'æ£€æµ‹åˆ°æ‚¨è¿˜æ²¡æœ‰è®¾ç½®ç§˜é’¥ï¼Œè¯·è®¾ç½®ä¸€ä¸ªç§˜é’¥ç”¨äºå®‰å…¨éªŒè¯',
						showInput: true,
						inputPlaceholder: 'è¯·è¾“å…¥æ–°ç§˜é’¥ï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰',
						onConfirm: async (inputSecretKey) => {
							if (!inputSecretKey || inputSecretKey.trim().length < 3) {
								this.showToast('ç§˜é’¥é•¿åº¦è‡³å°‘3ä¸ªå­—ç¬¦', 'error');
								return false; // é˜»æ­¢å¼¹çª—å…³é—­
							}

							// è®¾ç½®æ–°ç§˜é’¥
							const success = await this.setNewSecretKey(inputSecretKey.trim());
							if (success) {
								this.showToast('ç§˜é’¥è®¾ç½®æˆåŠŸï¼', 'success');
								return true; // å…è®¸å¼¹çª—å…³é—­
							} else {
								return false; // é˜»æ­¢å¼¹çª—å…³é—­
							}
						},
						onCancel: () => {
							this.showToast('è¯·è®¾ç½®ç§˜é’¥åæ‰èƒ½ä½¿ç”¨ç¼–è¾‘å™¨', 'warning');
							// å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–å¤„ç†ï¼Œæ¯”å¦‚ç¦ç”¨æŸäº›åŠŸèƒ½
						}
					});
				}

				async setNewSecretKey(secretKey) {
					try {
						const userId = this.getUserIdFromUrl();

						// è°ƒç”¨æœåŠ¡å™¨APIä¿å­˜ç§˜é’¥åˆ°key.json
						const response = await fetch('/api/save-secret-key', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								userId: userId,
								secretKey: secretKey
							})
						});

						if (response.ok) {
							// å­˜å‚¨åˆ°localStorageä»¥ä¾¿åç»­ä½¿ç”¨
							localStorage.setItem('speech_stats_secret_key', secretKey);
							return true;
						} else {
							const errorData = await response.json();
							this.showToast('è®¾ç½®ç§˜é’¥å¤±è´¥ï¼š' + (errorData.error || 'æœªçŸ¥é”™è¯¯'), 'error');
							return false;
						}
					} catch (error) {
						console.error('è®¾ç½®ç§˜é’¥å¤±è´¥:', error);
						this.showToast('è®¾ç½®ç§˜é’¥å¤±è´¥ï¼š' + error.message, 'error');
						return false;
					}
				}

				async validateInputSecretKey(inputSecretKey) {
					try {
						const userId = this.getUserIdFromUrl();
						const response = await fetch('/api/validate-secret-key', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								userId: userId,
								secretKey: inputSecretKey
							})
						});

						if (response.ok) {
							const result = await response.json();
							return result.valid === true;
						} else {
							return false;
						}
					} catch (error) {
						console.error('éªŒè¯è¾“å…¥ç§˜é’¥å¤±è´¥:', error);
						return false;
					}
				}

				generateRandomKey() {
					const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
					let result = '';
					for (let i = 0; i < 32; i++) {
						result += chars.charAt(Math.floor(Math.random() * chars.length));
					}
					return result;
				}

				showModal(options) {
					const {
						title = 'æç¤º',
							message = '',
							showInput = false,
							inputPlaceholder = 'è¯·è¾“å…¥å†…å®¹',
							onConfirm = null,
							onCancel = null
					} = options;

					// è®¾ç½®å¼¹çª—å†…å®¹
					this.elements.modalTitle.textContent = title;
					this.elements.modalMessage.textContent = message;

					if (showInput) {
						this.elements.modalInputGroup.style.display = 'block';
						this.elements.modalInput.placeholder = inputPlaceholder;
						this.elements.modalInput.value = '';
					} else {
						this.elements.modalInputGroup.style.display = 'none';
					}

					// è®¾ç½®æŒ‰é’®äº‹ä»¶
					const handleConfirm = () => {
						if (showInput) {
							const value = this.elements.modalInput.value;
							if (onConfirm) {
								const result = onConfirm(value);
								if (result !== false) {
									this.hideModal();
								}
							} else {
								this.hideModal();
							}
						} else {
							if (onConfirm) {
								const result = onConfirm();
								if (result !== false) {
									this.hideModal();
								}
							} else {
								this.hideModal();
							}
						}
					};

					const handleCancel = () => {
						if (onCancel) {
							onCancel();
						}
						this.hideModal();
					};

					// ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
					this.elements.modalConfirm.replaceWith(this.elements.modalConfirm.cloneNode(true));
					this.elements.modalCancel.replaceWith(this.elements.modalCancel.cloneNode(true));

					// é‡æ–°è·å–å…ƒç´ å¹¶æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
					this.elements.modalConfirm = document.getElementById('modalConfirm');
					this.elements.modalCancel = document.getElementById('modalCancel');

					this.elements.modalConfirm.addEventListener('click', handleConfirm);
					this.elements.modalCancel.addEventListener('click', handleCancel);

					// ç»‘å®š ESC å…³é—­å¼¹çª—ï¼ˆå…ˆç§»é™¤æ—§ç›‘å¬é¿å…é‡å¤ï¼‰
					if (this._modalKeydownHandler) {
						document.removeEventListener('keydown', this._modalKeydownHandler);
					}
					this._modalKeydownHandler = (e) => {
						if (e.key === 'Escape') {
							handleCancel();
						}
					};
					document.addEventListener('keydown', this._modalKeydownHandler);

					// æ˜¾ç¤ºå¼¹çª—
					this.elements.modalOverlay.style.display = 'flex';
					setTimeout(() => {
						this.elements.modalOverlay.classList.add('show');
					}, 10);

					// èšç„¦åˆ°è¾“å…¥æ¡†
					if (showInput) {
						setTimeout(() => {
							this.elements.modalInput.focus();
						}, 300);
					}
				}

				hideModal() {
					this.elements.modalOverlay.classList.remove('show');

					// è§£é™¤ ESC ç›‘å¬
					if (this._modalKeydownHandler) {
						document.removeEventListener('keydown', this._modalKeydownHandler);
						this._modalKeydownHandler = null;
					}
					setTimeout(() => {
						this.elements.modalOverlay.style.display = 'none';
					}, 300);
				}

				async getSecretKey() {
					try {
						const userId = this.getUserIdFromUrl();

						// ä¼˜å…ˆä»æœåŠ¡å™¨è·å–ç§˜é’¥
						const response = await fetch(`/api/secret-key/${userId}`);
						if (response.ok) {
							const data = await response.json();
							if (data.secretKey) {
								// æœåŠ¡å™¨æœ‰ç§˜é’¥ï¼Œå­˜å‚¨åˆ°localStorageä½œä¸ºç¼“å­˜
								localStorage.setItem('speech_stats_secret_key', data.secretKey);
								return data.secretKey;
							}
						}

						// æœåŠ¡å™¨æ²¡æœ‰ç§˜é’¥ï¼Œæ£€æŸ¥localStorage
						const storedKey = localStorage.getItem('speech_stats_secret_key');
						if (storedKey) {
							return storedKey;
						}

						// éƒ½æ²¡æœ‰ï¼Œæç¤ºç”¨æˆ·è®¾ç½®
						this.showSecretKeySetupModal();
						throw new Error('è¯·å…ˆè®¾ç½®ç§˜é’¥');
					} catch (error) {
						console.error('è·å–ç§˜é’¥å¤±è´¥:', error);
						// æ£€æŸ¥localStorageä½œä¸ºå¤‡ç”¨
						const storedKey = localStorage.getItem('speech_stats_secret_key');
						if (storedKey) {
							return storedKey;
						}

						this.showSecretKeySetupModal();
						throw new Error('è¯·å…ˆè®¾ç½®ç§˜é’¥');
					}
				}

				getBackgroundType() {
					return document.querySelector('input[name="backgroundType"]:checked').value;
				}

				showResetKeyModal() {
					// åˆ›å»ºè‡ªå®šä¹‰çš„é‡ç½®ç§˜é’¥å¼¹çª—
					this.showCustomResetKeyModal();
				}

				showCustomResetKeyModal() {
					// åˆ›å»ºå¼¹çª—HTML
					const modalHTML = `
						<div class="modal-overlay show" id="resetKeyModalOverlay">
							<div class="modal-container">
								<div class="modal-header">
									<h3 class="modal-title">ğŸ” é‡ç½®ç§˜é’¥</h3>
									<button class="modal-close" id="resetKeyModalClose">Ã—</button>
								</div>
								<div class="modal-body">
									<p class="modal-message">è¯·è¾“å…¥æ–°çš„ç§˜é’¥ï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰ï¼Œå¹¶å®ŒæˆéªŒè¯ç æ ¡éªŒ</p>
									<div class="reset-key-form">
										<div class="input-group">
											<label class="input-label">æ–°ç§˜é’¥</label>
											<input type="text" class="modal-input" id="resetKeyInput" placeholder="è¯·è¾“å…¥æ–°ç§˜é’¥ï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰">
										</div>
										<div class="input-group">
											<label class="input-label">éªŒè¯ç </label>
											<div class="verification-group">
												<input type="text" class="modal-input verification-input" id="resetKeyVerifyCode" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6">
												<button class="send-code-btn" id="resetKeySendCode">å‘é€éªŒè¯ç </button>
											</div>
											<div class="verification-hint">è¯·ç¡®è®¤å·²æ·»åŠ BOTä¸ºQQå¥½å‹</div>
										</div>
									</div>
								</div>
								<div class="modal-footer">
									<button class="modal-btn modal-btn-secondary" id="resetKeyCancel">å–æ¶ˆ</button>
									<button class="modal-btn modal-btn-primary" id="resetKeyConfirm">ç¡®å®š</button>
								</div>
							</div>
						</div>
					`;

					// ç§»é™¤ç°æœ‰å¼¹çª—
					const existingModal = document.getElementById('resetKeyModalOverlay');
					if (existingModal) {
						existingModal.remove();
					}

					// æ·»åŠ æ–°å¼¹çª—åˆ°é¡µé¢
					document.body.insertAdjacentHTML('beforeend', modalHTML);

					// ç»‘å®šäº‹ä»¶
					this.bindResetKeyModalEvents();
				}

				bindResetKeyModalEvents() {
					const modal = document.getElementById('resetKeyModalOverlay');
					const closeBtn = document.getElementById('resetKeyModalClose');
					const cancelBtn = document.getElementById('resetKeyCancel');
					const confirmBtn = document.getElementById('resetKeyConfirm');
					const sendCodeBtn = document.getElementById('resetKeySendCode');
					const keyInput = document.getElementById('resetKeyInput');
					const codeInput = document.getElementById('resetKeyVerifyCode');

					// å…³é—­å¼¹çª—
					const closeModal = () => {
						modal.classList.remove('show');
						setTimeout(() => modal.remove(), 300);
					};

					// äº‹ä»¶ç»‘å®š
					closeBtn.addEventListener('click', closeModal);
					cancelBtn.addEventListener('click', closeModal);
					modal.addEventListener('click', (e) => {
						if (e.target === modal) closeModal();
					});

					// å‘é€éªŒè¯ç 
					sendCodeBtn.addEventListener('click', async () => {
						try {
							const userId = this.getUserIdFromUrl();
							const resp = await fetch('/api/send-verification-code', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify({
									userId
								})
							});
							if (resp.ok) {
								this.showToast('éªŒè¯ç å·²å‘é€ï¼Œæœ‰æ•ˆæœŸ5åˆ†é’Ÿ', 'success');
								sendCodeBtn.textContent = 'é‡æ–°å‘é€';
								sendCodeBtn.disabled = true;
								setTimeout(() => {
									sendCodeBtn.disabled = false;
									sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
								}, 60000); // 60ç§’å†·å´
							} else {
								const data = await resp.json().catch(() => ({}));
								this.showToast('å‘é€å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
							}
						} catch (e) {
							this.showToast('å‘é€å¤±è´¥ï¼š' + e.message, 'error');
						}
					});

					// ç¡®è®¤é‡ç½®
					confirmBtn.addEventListener('click', async () => {
						const newKey = keyInput.value.trim();
						const code = codeInput.value.trim();

						if (!newKey || newKey.length < 3) {
							this.showToast('ç§˜é’¥é•¿åº¦è‡³å°‘3ä¸ªå­—ç¬¦', 'error');
							return;
						}

						if (!/^[0-9]{6}$/.test(code)) {
							this.showToast('è¯·å¡«å†™6ä½æ•°å­—éªŒè¯ç ', 'error');
							return;
						}

						try {
							const userId = this.getUserIdFromUrl();
							const verifyResp = await fetch('/api/verify-code', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify({
									userId,
									code
								})
							});
							if (!verifyResp.ok) {
								const data = await verifyResp.json().catch(() => ({}));
								this.showToast(data.error || 'éªŒè¯ç æ ¡éªŒå¤±è´¥', 'error');
								return;
							}

							const ok = await this.setNewSecretKey(newKey);
							if (ok) {
								this.showToast('ç§˜é’¥å·²æ›´æ–°', 'success');
								closeModal();
							}
						} catch (e) {
							this.showToast('éªŒè¯ç æ ¡éªŒå¤±è´¥ï¼š' + e.message, 'error');
						}
					});

					// å›è½¦é”®ç¡®è®¤
					keyInput.addEventListener('keypress', (e) => {
						if (e.key === 'Enter') confirmBtn.click();
					});
					codeInput.addEventListener('keypress', (e) => {
						if (e.key === 'Enter') confirmBtn.click();
					});

					// èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
					setTimeout(() => keyInput.focus(), 100);
				}

				showSettingsModal() {
					// å…¼å®¹è°ƒç”¨ï¼šç›´æ¥è¿›å…¥é‡ç½®ç§˜é’¥æµç¨‹
					this.showResetKeyModal();
				}

				regenerateSecretKey() {
					// æ¸…é™¤ç°æœ‰ç§˜é’¥
					localStorage.removeItem('speech_stats_secret_key');

					// é‡æ–°ç”Ÿæˆç§˜é’¥
					this.generateSecretKeyFile();

					this.showToast('ç§˜é’¥å·²é‡æ–°ç”Ÿæˆ', 'success');
				}
			}

			// åˆå§‹åŒ–ç¼–è¾‘å™¨
			document.addEventListener('DOMContentLoaded', () => {
				new ImageEditorV2();
			});
		</script>
	</body>
</html>